diff --git a/assets/prompts/ags_prompt.md b/assets/prompts/ags_prompt.md
index 1e621aa..7516af5 100644
--- a/assets/prompts/ags_prompt.md
+++ b/assets/prompts/ags_prompt.md
@@ -26,8 +26,9 @@ Bu sÄ±nav iki ana oturumdan oluÅŸur ve plan her ikisini de kapsamalÄ±dÄ±r:
 **GÃ–REV:** Plan hazÄ±rlarken hem "Ortak" konulardan hem de "Alan" konularÄ±ndan dengeli bir karÄ±ÅŸÄ±m yapmalÄ±sÄ±n.
 
 ### 3. VERÄ° ODAKLI PLANLAMA
-- **ZayÄ±f Noktalar:** {{TOPIC_PERFORMANCES_JSON}} verisine bak. BaÅŸarÄ±sÄ±z (kÄ±rmÄ±zÄ±) konularÄ± tespit et ve bu haftaya ekle.
-- **Konu SeÃ§imi:** KonularÄ± kafandan uydurma, mutlaka {{CURRICULUM_JSON}} listesinden seÃ§.
+- **Konu SeÃ§imi:** {{CURRICULUM_JSON}} iÃ§indeki "candidates" listesinden seÃ§. Bu liste otomatik filtrelenmiÅŸtir.
+- **Ders OrtalamalarÄ±:** {{SUBJECT_AVERAGES}} verilerine gÃ¶re zayÄ±f alanlarÄ± belirle ve Ã¶nceliklendir.
+- Deneme sonuÃ§larÄ±na gÃ¶re eksik konularÄ± bu haftanÄ±n odaÄŸÄ±na al.
 
 ### 4. DERS DAÄILIMI VE STRATEJÄ°
 - **EÄŸitim Bilimleri:** Haftada en az 4 gÃ¼n yer ver.
@@ -42,7 +43,7 @@ Bu sÄ±nav iki ana oturumdan oluÅŸur ve plan her ikisini de kapsamalÄ±dÄ±r:
 - **Test:** Deneme sÄ±navÄ± sÃ¼resi
 
 ### 6. PLAN YENÄ°LEME
-- Ã–nceki plan ({{WEEKLY_PLAN_TEXT}}) ile aynÄ± planÄ± Ã¼retme. KullanÄ±cÄ±yÄ± her hafta bir adÄ±m ileri taÅŸÄ±.
+- Her hafta farklÄ± konular ve gÃ¶revlerle kullanÄ±cÄ±yÄ± bir adÄ±m ileri taÅŸÄ±.
 
 {{REVISION_BLOCK}}
 
@@ -56,8 +57,6 @@ Bu sÄ±nav iki ana oturumdan oluÅŸur ve plan her ikisini de kapsamalÄ±dÄ±r:
 ### Performans Raporu
 - Ã–ÄŸrenci ID: {{USER_ID}}
 - SÄ±nava Kalan GÃ¼n: {{DAYS_UNTIL_EXAM}}
-- Hedef: {{GOAL}}
-- Zorluklar: {{CHALLENGES}}
 - Tempo Tercihi: {{PACING}}
 - Deneme SayÄ±sÄ±: {{TEST_COUNT}}
 - Ortalama Net: {{AVG_NET}}
@@ -68,15 +67,6 @@ Bu sÄ±nav iki ana oturumdan oluÅŸur ve plan her ikisini de kapsamalÄ±dÄ±r:
 {{TOPIC_PERFORMANCES_JSON}}
 ```
 
-### GeÃ§en HaftanÄ±n PlanÄ±
-```json
-{{WEEKLY_PLAN_TEXT}}
-```
-
-### Tamamlanan GÃ¶revler
-```json
-{{COMPLETED_TASKS_JSON}}
-```
 
 ### MÃ¼fredat SÄ±rasÄ± (KONU HAVUZU)
 ```json
diff --git a/assets/prompts/kpss_prompt.md b/assets/prompts/kpss_prompt.md
index d5aa18e..c7c31ed 100644
--- a/assets/prompts/kpss_prompt.md
+++ b/assets/prompts/kpss_prompt.md
@@ -28,10 +28,10 @@ Bu adayÄ±n {{EXAM_NAME}} atanma hedefi iÃ§in mevcut zamanÄ±nÄ± maksimum verimle
 - Hafta sonu kapsamlÄ± test Ã§Ã¶zÃ¼mÃ¼
 
 ### 4. MÃœFREDAT SIRASI TAKÄ°BÄ°
-- AÅŸaÄŸÄ±daki mÃ¼fredat sÄ±rasÄ±na uy: {{CURRICULUM_JSON}}
+- AÅŸaÄŸÄ±daki aday konu listesinden seÃ§: {{CURRICULUM_JSON}}
 - Backlog varsa Ã¶nce onu tamamla: {{GUARDRAILS_JSON}}
-- KÄ±rmÄ±zÄ±/sarÄ± konularÄ± Ã¶nceliklendir
-- YeÅŸil konular iÃ§in sadece review
+- Ders ortalamalarÄ± ve deneme sonuÃ§larÄ±na gÃ¶re zayÄ±f alanlarÄ± Ã¶nceliklendir
+- GeliÅŸim gÃ¶steren konular iÃ§in pekiÅŸtirme tekrarlarÄ±
 
 ### 5. TEMPO UYUMU (PACING)
 - **intense**: MÃ¼sait zamanÄ±n %90'Ä±nÄ± doldur (Ã§ok disiplinli)
@@ -56,11 +56,11 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 - GÃ¼ncel olaylarÄ± takip (Ã¶zellikle GK iÃ§in)
 
 ### 8. KRÄ°TÄ°K UYARI: PLAN YENÄ°LEME KURALI
-âš ï¸ **ASLA AYNI PLANI TEKRARLAMA!**
-- EÄŸer geÃ§miÅŸ haftanÄ±n planÄ± verilmiÅŸse ({{WEEKLY_PLAN_TEXT}}), birebir aynÄ± gÃ¶revleri ASLA Ã¼retme
+âš ï¸ **HER HAFTA YENÄ° VE FARKLI PLAN!**
+- Her hafta adayÄ±n geliÅŸimine gÃ¶re farklÄ± konular ve gÃ¶revler oluÅŸtur
 - Aday geliÅŸim gÃ¶steriyor, gÃ¶revlerin zorluÄŸunu ARTIR
 - FarklÄ± soru tipleri, farklÄ± konular, farklÄ± deneme sÄ±navlarÄ± kullan
-- Ã–nceki planla %100 aynÄ± olan bir plan Ã¼retmek YASAKTIR
+- Ã‡eÅŸitlilik ve ilerlemeci yaklaÅŸÄ±m ÅŸart
 
 {{REVISION_BLOCK}}
 
@@ -75,8 +75,6 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 - Aday ID: {{USER_ID}}
 - SÄ±nav: {{EXAM_NAME}}
 - Atanmaya Kalan GÃ¼n: {{DAYS_UNTIL_EXAM}}
-- Hedef Kadro: {{GOAL}}
-- Engeller: {{CHALLENGES}}
 - Tempo Tercihi: {{PACING}}
 - Toplam Deneme: {{TEST_COUNT}}
 - Ortalama Net: {{AVG_NET}}
@@ -87,15 +85,6 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 {{TOPIC_PERFORMANCES_JSON}}
 ```
 
-### GeÃ§en HaftanÄ±n Analizi
-```json
-{{WEEKLY_PLAN_TEXT}}
-```
-
-### Tamamlanan GÃ¶revler
-```json
-{{COMPLETED_TASKS_JSON}}
-```
 
 ### MÃ¼fredat SÄ±rasÄ± & Guardrails
 ```json
diff --git a/assets/prompts/lgs_prompt.md b/assets/prompts/lgs_prompt.md
index 6f72ea4..137900b 100644
--- a/assets/prompts/lgs_prompt.md
+++ b/assets/prompts/lgs_prompt.md
@@ -31,10 +31,10 @@ Bu Ã¶ÄŸrencinin LGS baÅŸarÄ±sÄ± iÃ§in okul sonrasÄ± ve hafta sonu zamanÄ±nÄ± mak
 - Analitik dÃ¼ÅŸÃ¼nme becerilerini geliÅŸtirici gÃ¶revler
 
 ### 4. MÃœFREDAT SIRASI TAKÄ°BÄ°
-- AÅŸaÄŸÄ±daki mÃ¼fredat sÄ±rasÄ±na uy: {{CURRICULUM_JSON}}
+- AÅŸaÄŸÄ±daki aday konu listesinden seÃ§: {{CURRICULUM_JSON}}
 - Backlog varsa Ã¶nce onu tamamla: {{GUARDRAILS_JSON}}
-- KÄ±rmÄ±zÄ±/sarÄ± konularÄ± Ã¶nceliklendir
-- YeÅŸil konular iÃ§in sadece review
+- Ders ortalamalarÄ± dÃ¼ÅŸÃ¼k olan konularÄ± Ã¶nceliklendir
+- GeliÅŸim gÃ¶steren konular iÃ§in pekiÅŸtirme tekrarlarÄ±
 
 ### 5. TEMPO UYUMU (PACING)
 - **intense**: MÃ¼sait zamanÄ±n %90'Ä±nÄ± doldur (Ã§ok Ã§alÄ±ÅŸkan)
@@ -67,11 +67,11 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 - KÄ±sa, etkili Ã§alÄ±ÅŸma oturumlarÄ± (45-60 dk)
 
 ### 8. KRÄ°TÄ°K UYARI: PLAN YENÄ°LEME KURALI
-âš ï¸ **ASLA AYNI PLANI TEKRARLAMA!**
-- EÄŸer geÃ§miÅŸ haftanÄ±n planÄ± verilmiÅŸse ({{WEEKLY_PLAN_TEXT}}), birebir aynÄ± gÃ¶revleri ASLA Ã¼retme
+âš ï¸ **HER HAFTA YENÄ° VE FARKLI PLAN!**
+- Her hafta Ã¶ÄŸrencinin geliÅŸimine gÃ¶re farklÄ± konular ve gÃ¶revler oluÅŸtur
 - Ã–ÄŸrenci geliÅŸim gÃ¶steriyor, gÃ¶revlerin zorluÄŸunu ARTIR
 - FarklÄ± soru tipleri, farklÄ± konular, farklÄ± deneme sÄ±navlarÄ± kullan
-- Ã–nceki planla %100 aynÄ± olan bir plan Ã¼retmek YASAKTIR
+- Ã‡eÅŸitlilik ve ilerlemeci yaklaÅŸÄ±m ÅŸart
 
 {{REVISION_BLOCK}}
 
@@ -86,8 +86,6 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 - Ã–ÄŸrenci ID: {{USER_ID}}
 - SÄ±nav: LGS
 - SÄ±nava Kalan GÃ¼n: {{DAYS_UNTIL_EXAM}}
-- Hedef Okul: {{GOAL}}
-- Zorluklar: {{CHALLENGES}}
 - Tempo Tercihi: {{PACING}}
 - Toplam Deneme: {{TEST_COUNT}}
 - Ortalama Net: {{AVG_NET}}
@@ -98,15 +96,6 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 {{TOPIC_PERFORMANCES_JSON}}
 ```
 
-### GeÃ§en HaftanÄ±n PlanÄ±
-```json
-{{WEEKLY_PLAN_TEXT}}
-```
-
-### Tamamlanan GÃ¶revler
-```json
-{{COMPLETED_TASKS_JSON}}
-```
 
 ### MÃ¼fredat SÄ±rasÄ± & Guardrails
 ```json
diff --git a/assets/prompts/yks_prompt.md b/assets/prompts/yks_prompt.md
index 8c48622..df2c82a 100644
--- a/assets/prompts/yks_prompt.md
+++ b/assets/prompts/yks_prompt.md
@@ -57,8 +57,8 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 - Uzunluk: Maksimum 150 karakter
 
 ### 8. PLAN YENÄ°LEME KURALI
-âš ï¸ **ASLA AYNI PLANI TEKRARLAMA!**
-- EÄŸer geÃ§miÅŸ haftanÄ±n planÄ± verilmiÅŸse ({{WEEKLY_PLAN_TEXT}}), birebir aynÄ± gÃ¶revleri ASLA Ã¼retme.
+âš ï¸ **HER HAFTA YENÄ° VE FARKLI PLAN!**
+- Her hafta Ã¶ÄŸrencinin geliÅŸimine gÃ¶re farklÄ± konular ve gÃ¶revler oluÅŸtur.
 - KullanÄ±cÄ± geliÅŸim gÃ¶steriyor, gÃ¶revlerin zorluÄŸunu ARTIR.
 
 {{REVISION_BLOCK}}
@@ -74,27 +74,11 @@ Her gÃ¶revin tipi ÅŸunlardan biri olmalÄ±:
 - Ã–ÄŸrenci ID: {{USER_ID}}
 - SÄ±nav BÃ¶lÃ¼mÃ¼: {{SELECTED_EXAM_SECTION}}
 - SÄ±nava Kalan GÃ¼n: {{DAYS_UNTIL_EXAM}}
-- Hedef: {{GOAL}}
-- Zorluklar: {{CHALLENGES}}
 - Tempo Tercihi: {{PACING}}
 - Toplam Deneme: {{TEST_COUNT}}
 - Ortalama Net: {{AVG_NET}}
 - Ders OrtalamalarÄ±: {{SUBJECT_AVERAGES}}
 
-### Konu Performans DetaylarÄ± (ZAYIF NOKTALAR BURADA)
-```json
-{{TOPIC_PERFORMANCES_JSON}}
-```
-
-### GeÃ§en HaftanÄ±n PlanÄ±
-```json
-{{WEEKLY_PLAN_TEXT}}
-```
-
-### Tamamlanan GÃ¶revler
-```json
-{{COMPLETED_TASKS_JSON}}
-```
 
 ### MÃ¼fredat SÄ±rasÄ± (KONU HAVUZU)
 ```json
@@ -133,5 +117,5 @@ Sadece aÅŸaÄŸÄ±daki JSON formatÄ±nda Ã§Ä±ktÄ± ver. AÃ§Ä±klama, yorum YOK:
 
 ## CRITICAL WARNINGS
 - Her gÃ¼nÃ¼n schedule dizisi DOLU olmalÄ±
-- Konu isimleri {{CURRICULUM_JSON}} iÃ§inden seÃ§ilmeli
+- Konu isimleri {{CURRICULUM_JSON}}'daki "candidates" listesinden seÃ§ilmeli
 - Hem TYT hem AYT konularÄ± dengeli daÄŸÄ±tÄ±lmalÄ±
diff --git a/functions/src/tests.js b/functions/src/tests.js
index b710aa4..67da6ea 100644
--- a/functions/src/tests.js
+++ b/functions/src/tests.js
@@ -1,7 +1,7 @@
 const { onCall, HttpsError } = require("firebase-functions/v2/https");
 const { logger } = require("firebase-functions");
 const { db, admin } = require("./init");
-const { nowIstanbul, computeTestAggregates, enforceRateLimit, enforceDailyQuota, getClientIpFromRawRequest } = require("./utils");
+const { nowIstanbul, computeTestAggregates, enforceRateLimit, enforceDailyQuota, getClientIpFromRawRequest, isBranchTest } = require("./utils");
 const { updatePublicProfile } = require("./profile");
 
 exports.addEngagementPoints = onCall({ region: "us-central1", enforceAppCheck: true, maxInstances: 20 }, async (request) => {
@@ -120,6 +120,9 @@ exports.addTestResult = onCall({ region: "us-central1", timeoutSeconds: 30, enfo
         }
       }
 
+      // BranÅŸ denemesi kontrolÃ¼
+      const isTestBranch = isBranchTest(normalizedScores, sectionName, examType);
+
       // Åimdi tÃ¼m yazma iÅŸlemleri
       const newDocRef = testsCol.doc();
       newTestId = newDocRef.id;
@@ -137,18 +140,26 @@ exports.addTestResult = onCall({ region: "us-central1", timeoutSeconds: 30, enfo
         totalWrong,
         totalBlank,
         penaltyCoefficient,
+        isBranchTest: isTestBranch,
         createdAt: admin.firestore.FieldValue.serverTimestamp(),
       });
 
       // Ä°statistikleri gÃ¼ncelle (onUserStatsWritten trigger'Ä± buradan tetiklenecek)
-      tx.set(statsRef, {
-        testCount: admin.firestore.FieldValue.increment(1),
-        totalNetSum: admin.firestore.FieldValue.increment(totalNet),
+      // testCount ve totalNetSum sadece ana sÄ±nav denemeleri iÃ§in artÄ±rÄ±lÄ±r (branÅŸ denemeleri hariÃ§)
+      const statsUpdate = {
         streak: newStreak,
         lastStreakUpdate: admin.firestore.Timestamp.fromDate(today),
         engagementScore: admin.firestore.FieldValue.increment(pointsAward),
         updatedAt: admin.firestore.FieldValue.serverTimestamp(),
-      }, { merge: true });
+      };
+
+      // Sadece ana sÄ±nav denemelerinde testCount ve totalNetSum'Ä± artÄ±r
+      if (!isTestBranch) {
+        statsUpdate.testCount = admin.firestore.FieldValue.increment(1);
+        statsUpdate.totalNetSum = admin.firestore.FieldValue.increment(totalNet);
+      }
+
+      tx.set(statsRef, statsUpdate, { merge: true });
 
       if (!questsSnap.empty) {
         for (const doc of questsSnap.docs) {
diff --git a/functions/src/utils.js b/functions/src/utils.js
index 1f161ae..e55a767 100644
--- a/functions/src/utils.js
+++ b/functions/src/utils.js
@@ -171,6 +171,53 @@ function getClientIpFromRawRequest(rawRequest) {
   return null;
 }
 
+// BranÅŸ denemesi kontrolÃ¼ (Dart'taki TestModel.isBranchTest mantÄ±ÄŸÄ±)
+function isBranchTest(scores, sectionName, examType) {
+  if (!scores || typeof scores !== "object") return false;
+
+  const scoreKeys = Object.keys(scores);
+
+  // 1. EÄŸer sadece 1 ders varsa...
+  if (scoreKeys.length === 1) {
+    const subjectName = scoreKeys[0];
+    // Ä°STÄ°SNA: "Alan Bilgisi" veya "Temel Alan Bilgisi" -> Ana sÄ±nav
+    if (subjectName === "Alan Bilgisi" || subjectName === "Temel Alan Bilgisi") {
+      return false;
+    }
+    // DiÄŸer tek derslik durumlar branÅŸ denemesidir
+    return true;
+  }
+
+  const sectionUpper = (sectionName || "").toUpperCase().trim();
+  const examTypeUpper = (examType || "").toUpperCase().trim();
+
+  // 2. Ana sÄ±nav bÃ¶lÃ¼mleri - Kesin liste
+  const mainSections = ["TYT", "LGS", "KPSS", "AGS", "YDT", "GENEL", "TÃœMÃœ", "DENEME"];
+
+  // EÄŸer sectionName direkt sÄ±nav tÃ¼rÃ¼yle aynÄ±ysa -> Ana Deneme
+  if (sectionUpper === examTypeUpper) {
+    return false;
+  }
+
+  // Ana sÄ±nav isimlerini iÃ§eriyorsa -> Ana Deneme
+  if (mainSections.includes(sectionUpper)) {
+    return false;
+  }
+
+  // "TYT GENEL", "TYT DENEME" gibi kombinasyonlarÄ± yakala
+  if (sectionUpper.includes("GENEL") || (sectionUpper.includes(examTypeUpper) && sectionUpper.includes("DENEME"))) {
+    return false;
+  }
+
+  // AYT ve alt tÃ¼rleri (AYT-SAY, AYT-EA, AYT-SOZ, AYT-DIL, vs.) -> Ana Deneme
+  if (sectionUpper.startsWith("AYT")) {
+    return false;
+  }
+
+  // DiÄŸer her ÅŸey branÅŸ denemesi
+  return true;
+}
+
 module.exports = {
   nowIstanbul,
   dayKeyIstanbul,
@@ -181,4 +228,5 @@ module.exports = {
   enforceRateLimit,
   enforceDailyQuota,
   getClientIpFromRawRequest,
+  isBranchTest,
 };
diff --git a/lib/data/models/exam_model.dart b/lib/data/models/exam_model.dart
index 1be867d..5215f85 100644
--- a/lib/data/models/exam_model.dart
+++ b/lib/data/models/exam_model.dart
@@ -2,8 +2,6 @@
 import 'dart:convert';
 import 'package:flutter/services.dart';
 
-// --- VERÄ° MODELLERÄ° (Bunlar deÄŸiÅŸmedi, sadece temizlendi) ---
-
 enum ExamType {
   yks,
   lgs,
@@ -27,7 +25,7 @@ extension ExamTypeExtension on ExamType {
       case ExamType.kpssOrtaogretim:
         return 'KPSS OrtaÃ¶ÄŸretim';
       case ExamType.ags:
-        return 'AGS - Ã–ABT';
+        return 'AGS'; // "AGS - Ã–ABT" yerine sadeleÅŸtirildi
     }
   }
 }
diff --git a/lib/data/models/test_model.dart b/lib/data/models/test_model.dart
index 71ae471..96a1d1d 100644
--- a/lib/data/models/test_model.dart
+++ b/lib/data/models/test_model.dart
@@ -9,13 +9,13 @@ class TestModel {
   final ExamType examType;
   final String sectionName;
   final DateTime date;
-  final Map<String, Map<String, int>> scores; // { 'TÃ¼rkÃ§e': { 'dogru': 35, 'yanlis': 5, 'bos': 0 } }
+  final Map<String, Map<String, int>> scores;
   final double totalNet;
   final int totalQuestions;
   final int totalCorrect;
   final int totalWrong;
   final int totalBlank;
-  final double penaltyCoefficient; // Net hesaplamasÄ± iÃ§in katsayÄ±
+  final double penaltyCoefficient;
 
   TestModel({
     required this.id,
@@ -33,31 +33,31 @@ class TestModel {
     required this.penaltyCoefficient,
   });
 
-  // Firestore'dan gelen veriyi modele Ã§evirir
   factory TestModel.fromSnapshot(DocumentSnapshot<Map<String, dynamic>> doc) {
     final data = doc.data()!;
     final scoresData = (data['scores'] as Map<String, dynamic>).map(
-          (key, value) => MapEntry(key, (value as Map<String, dynamic>).cast<String, int>()),
+          (key, value) =>
+          MapEntry(key, (value as Map<String, dynamic>).cast<String, int>()),
     );
 
     return TestModel(
       id: doc.id,
       userId: data['userId'],
-      testName: data['testName'],
+      testName: data['testName'] ?? '',
       examType: ExamType.values.byName(data['examType']),
-      sectionName: data['sectionName'],
+      sectionName: data['sectionName'] ?? '',
       date: (data['date'] as Timestamp).toDate(),
       scores: scoresData,
       totalNet: (data['totalNet'] as num).toDouble(),
-      totalQuestions: data['totalQuestions'],
-      totalCorrect: data['totalCorrect'],
-      totalWrong: data['totalWrong'],
-      totalBlank: data['totalBlank'],
-      penaltyCoefficient: (data['penaltyCoefficient'] as num?)?.toDouble() ?? 0.25,
+      totalQuestions: data['totalQuestions'] ?? 0,
+      totalCorrect: data['totalCorrect'] ?? 0,
+      totalWrong: data['totalWrong'] ?? 0,
+      totalBlank: data['totalBlank'] ?? 0,
+      penaltyCoefficient:
+      (data['penaltyCoefficient'] as num?)?.toDouble() ?? 0.25,
     );
   }
 
-  // Modeli Firestore'a yazÄ±lacak JSON formatÄ±na Ã§evirir
   Map<String, dynamic> toJson() {
     return {
       'userId': userId,
@@ -77,63 +77,117 @@ class TestModel {
 }
 
 extension TestModelSummaryX on TestModel {
-  // KullanÄ±cÄ±nÄ±n performansÄ±na gÃ¶re bir "Bilgelik PuanÄ±" hesaplar.
+  // GÃœNCELLENMÄ°Å MANTIK: Ä°sim listesine baÄŸÄ±mlÄ±lÄ±ÄŸÄ± ortadan kaldÄ±ran evrensel Ã§Ã¶zÃ¼m
+  bool get isBranchTest {
+    // 1. Ã‡OKLU DERS KONTROLÃœ (En gÃ¼Ã§lÃ¼ ve genel kural)
+    // UygulamanÄ±zÄ±n mantÄ±ÄŸÄ±nda bir "BranÅŸ Denemesi" oluÅŸtururken sadece tek bir ders seÃ§ilebiliyor.
+    // DolayÄ±sÄ±yla, bir denemede 1'den fazla ders (subject) varsa, bu kesinlikle bir ANA SINAVDIR.
+    // Bu kural TYT, LGS ve Ã§ok dersli Ã–ABT branÅŸlarÄ±nÄ± (Ã–rn: SÄ±nÄ±f Ã–ÄŸretmenliÄŸi -> Temel Alan + Alan EÄŸitimi) otomatik kapsar.
+    if (scores.length > 1) {
+      return false;
+    }
+
+    // EÄŸer buraya geldiysek deneme TEK DERSTEN oluÅŸuyor demektir.
+    if (scores.isEmpty) return true; // Hata toleransÄ±
+
+    final subjectName = scores.keys.first.toUpperCase().trim();
+    final sectionUpper = sectionName.toUpperCase().trim();
+    final examTypeUpper = examType.name.toUpperCase();
+
+    // 2. KAPSAYICI DERS Ä°SÄ°MLERÄ° (Tek ders olsa bile tÃ¼m sÄ±navÄ± temsil edenler)
+    // YDT (YabancÄ± Dil) gibi tek derslik sÄ±navlarÄ± yakalamak iÃ§in sadece dersin adÄ±na bakarÄ±z.
+    // DÃœZELTME: "ALAN BÄ°LGÄ°SÄ°" kaldÄ±rÄ±ldÄ± Ã§Ã¼nkÃ¼ Ã–ABT'de bu bir branÅŸ denemesi olabilir.
+    final comprehensiveSubjectNames = [
+      'YABANCI DÄ°L',
+      'YABANCI DIL',
+      'ALAN BÄ°LGÄ°SÄ°',
+      'ALAN BILGISI',
+    ];
+
+    if (comprehensiveSubjectNames.contains(subjectName)) {
+      return false; // Ana SÄ±navdÄ±r
+    }
+
+    // 3. SINAV TÃœRÃœ EÅLEÅMESÄ°
+    // EÄŸer bÃ¶lÃ¼m adÄ± sÄ±nav tÃ¼rÃ¼yle aynÄ±ysa (Ã–rn: Section: YDT, Exam: YDT) ana sÄ±navdÄ±r.
+    if (sectionUpper == examTypeUpper) {
+      return false;
+    }
+
+    // 4. GENEL ANAHTAR KELÄ°MELER (DÃœZELTÄ°LDÄ°)
+    // "Genel" veya "TÃ¼mÃ¼" kelimeleri bÃ¶lÃ¼m adÄ±nÄ±n BAÅINDA geÃ§iyorsa ana sÄ±navdÄ±r.
+    // contains yerine startsWith kullanÄ±ldÄ±. BÃ¶ylece "Tarih (Genel KÃ¼ltÃ¼r)" gibi
+    // parantez iÃ§i kullanÄ±mlar yanlÄ±ÅŸlÄ±kla ana sÄ±nav sayÄ±lmayacak.
+    if (sectionUpper.startsWith('GENEL') || sectionUpper == 'TÃœMÃœ') {
+      return false;
+    }
+
+    // YukarÄ±daki ÅŸartlarÄ±n hiÃ§biri saÄŸlanmadÄ±ysa, bu bir branÅŸ denemesidir.
+    // (Ã–rn: TYT sÄ±navÄ±nda sadece "Matematik" Ã§Ã¶zÃ¼ldÃ¼yse veya KPSS'de sadece "Tarih" Ã§Ã¶zÃ¼ldÃ¼yse)
+    return true;
+  }
+
+  // Grafiklerde ve baÅŸlÄ±klarda gÃ¶rÃ¼necek akÄ±llÄ± isim
+  String get smartDisplayName {
+    // BranÅŸ denemesi ise dersin adÄ±nÄ± (Ã–rn: Ä°ngilizce), deÄŸilse bÃ¶lÃ¼m adÄ±nÄ± (Ã–rn: YDT) dÃ¶ndÃ¼rÃ¼r.
+    if (isBranchTest && scores.isNotEmpty) {
+      return scores.keys.first;
+    }
+    return sectionName;
+  }
+
   double get wisdomScore {
     if (totalQuestions == 0) return 0;
-
-    // Netin katkÄ±sÄ± (%60)
     final double netContribution = (totalNet / totalQuestions) * 60;
-
-    // DoÄŸruluk oranÄ±nÄ±n katkÄ±sÄ± (%25)
     final int attemptedQuestions = totalCorrect + totalWrong;
     final double accuracyContribution = attemptedQuestions > 0
         ? (totalCorrect / attemptedQuestions) * 25
         : 0;
-
-    // Ã‡aba/KatÄ±lÄ±m oranÄ±nÄ±n katkÄ±sÄ± (%15)
-    final double effortContribution = (attemptedQuestions / totalQuestions) * 15;
-
-    final double totalScore = netContribution + accuracyContribution + effortContribution;
+    final double effortContribution =
+        (attemptedQuestions / totalQuestions) * 15;
+    final double totalScore =
+        netContribution + accuracyContribution + effortContribution;
     return totalScore.clamp(0, 100);
   }
 
-  // Puan aralÄ±ÄŸÄ±na gÃ¶re uzman yorumu ve unvanÄ± dÃ¶ndÃ¼rÃ¼r.
   Map<String, String> get expertVerdict => getExpertVerdict(wisdomScore);
 
   Map<String, String> getExpertVerdict(double score) {
     if (score > 85) {
       return {
         "title": "Efsanevi SavaÅŸÃ§Ä±",
-        "verdict": "Zirvedeki yerin sarsÄ±lmaz. Bilgin bir kÄ±lÄ±Ã§ gibi keskin, iraden ise bir zÄ±rh kadar saÄŸlam. Bu yolda devam et, zafer seni bekliyor."
+        "verdict":
+        "Zirvedeki yerin sarsÄ±lmaz. Bilgin bir kÄ±lÄ±Ã§ gibi keskin, iraden ise bir zÄ±rh kadar saÄŸlam. Bu yolda devam et, zafer seni bekliyor."
       };
     } else if (score > 70) {
       return {
         "title": "Usta Stratejist",
-        "verdict": "SavaÅŸ meydanÄ±nÄ± okuyorsun. GÃ¼Ã§lÃ¼ ve zayÄ±f yÃ¶nlerini biliyorsun. KÃ¼Ã§Ã¼k gedikleri kapatarak yenilmez olacaksÄ±n. Potansiyelin parlÄ±yor."
+        "verdict":
+        "SavaÅŸ meydanÄ±nÄ± okuyorsun. GÃ¼Ã§lÃ¼ ve zayÄ±f yÃ¶nlerini biliyorsun. KÃ¼Ã§Ã¼k gedikleri kapatarak yenilmez olacaksÄ±n. Potansiyelin parlÄ±yor."
       };
     } else if (score > 50) {
       return {
         "title": "Yetenekli SavaÅŸÃ§Ä±",
-        "verdict": "GÃ¼cÃ¼n ve cesaretin takdire ÅŸayan. Temellerin saÄŸlam, ancak bazÄ± hamlelerinde tereddÃ¼t var. Pratik ve odaklanma ile bu savaÅŸÄ± kazanacaksÄ±n."
+        "verdict":
+        "GÃ¼cÃ¼n ve cesaretin takdire ÅŸayan. Temellerin saÄŸlam, ancak bazÄ± hamlelerinde tereddÃ¼t var. Pratik ve odaklanma ile bu savaÅŸÄ± kazanacaksÄ±n."
       };
     } else if (score > 30) {
       return {
         "title": "Azimli Acemi",
-        "verdict": "Her bÃ¼yÃ¼k savaÅŸÃ§Ä± bu yoldan geÃ§ti. KaybettiÄŸin her mevzi, Ã¶ÄŸrendiÄŸin yeni bir derstir. Azmin en bÃ¼yÃ¼k silahÄ±n, pes etme."
+        "verdict":
+        "Her bÃ¼yÃ¼k savaÅŸÃ§Ä± bu yoldan geÃ§ti. KaybettiÄŸin her mevzi, Ã¶ÄŸrendiÄŸin yeni bir derstir. Azmin en bÃ¼yÃ¼k silahÄ±n, pes etme."
       };
     } else {
       return {
         "title": "Yolun BaÅŸÄ±ndaki KÃ¢ÅŸif",
-        "verdict": "Unutma, en uzun yolculuklar tek bir adÄ±mla baÅŸlar. Bu ilk adÄ±mÄ± attÄ±n. Åimdi hatalarÄ±ndan Ã¶ÄŸrenme ve gÃ¼Ã§lenme zamanÄ±. YanÄ±ndayÄ±m."
+        "verdict":
+        "Unutma, en uzun yolculuklar tek bir adÄ±mla baÅŸlar. Bu ilk adÄ±mÄ± attÄ±n. Åimdi hatalarÄ±ndan Ã¶ÄŸrenme ve gÃ¼Ã§lenme zamanÄ±. YanÄ±ndayÄ±m."
       };
     }
   }
 
-  // En gÃ¼Ã§lÃ¼ ve en zayÄ±f dersleri bulan fonksiyon (yÃ¼zdeye gÃ¶re)
   Map<String, MapEntry<String, double>> findKeySubjects() {
-    if (scores.isEmpty) {
-      return {};
-    }
+    if (scores.isEmpty) return {};
 
     MapEntry<String, double>? strongest;
     MapEntry<String, double>? weakest;
@@ -141,14 +195,12 @@ extension TestModelSummaryX on TestModel {
     for (final entry in scores.entries) {
       final subject = entry.key;
       final scoresMap = entry.value;
-
       final d = scoresMap['dogru'] ?? 0;
       final y = scoresMap['yanlis'] ?? 0;
       final b = scoresMap['bos'] ?? 0;
       final totalQuestions = d + y + b;
 
-      if (totalQuestions == 0) continue; // Bu dersi atla
-
+      if (totalQuestions == 0) continue;
       final accuracy = (d / totalQuestions) * 100.0;
 
       if (strongest == null || accuracy > strongest.value) {
@@ -160,10 +212,6 @@ extension TestModelSummaryX on TestModel {
     }
 
     if (strongest == null || weakest == null) return {};
-
-    return {
-      'strongest': strongest,
-      'weakest': weakest,
-    };
+    return {'strongest': strongest, 'weakest': weakest};
   }
-}
+}
\ No newline at end of file
diff --git a/lib/data/providers/firestore_providers.dart b/lib/data/providers/firestore_providers.dart
index 4fdcb4b..fafffbc 100644
--- a/lib/data/providers/firestore_providers.dart
+++ b/lib/data/providers/firestore_providers.dart
@@ -252,3 +252,13 @@ final searchResultsProvider = FutureProvider.autoDispose<List<Map<String, dynami
     (result) => result['userId'] as String,
   );
 });
+
+/// GerÃ§ek deneme sayÄ±sÄ±: tests koleksiyonundan gelir (silinen denemeler otomatik dÃ¼ÅŸer)
+final testCountForUserProvider = StreamProvider.family.autoDispose<int, String>((ref, userId) {
+  return ref.watch(firestoreServiceProvider).streamTestCount(userId);
+});
+
+/// GerÃ§ek toplam net: tests koleksiyonundan gelir (silinen denemeler otomatik Ã§Ä±kar)
+final totalNetSumForUserProvider = StreamProvider.family.autoDispose<double, String>((ref, userId) {
+  return ref.watch(firestoreServiceProvider).streamTotalNetSum(userId);
+});
diff --git a/lib/data/repositories/firestore_service.dart b/lib/data/repositories/firestore_service.dart
index c116aec..a31c2c2 100644
--- a/lib/data/repositories/firestore_service.dart
+++ b/lib/data/repositories/firestore_service.dart
@@ -8,7 +8,7 @@ import 'package:taktik/data/models/test_model.dart';
 import 'package:taktik/data/models/exam_model.dart';
 import 'package:taktik/data/models/topic_performance_model.dart';
 import 'package:taktik/data/models/focus_session_model.dart';
-import 'package:taktik/features/weakness_workshop/models/saved_workshop_model.dart';
+import 'package:taktik/features/weakness_workshop/models/workshop_model.dart';
 import 'package:taktik/data/models/plan_document.dart';
 import 'package:taktik/data/models/performance_summary.dart';
 import 'package:taktik/data/models/app_state.dart';
@@ -48,13 +48,13 @@ class FirestoreService {
   CollectionReference<Map<String, dynamic>> get _questionReportsIndexCollection => _firestore.collection('question_report_index');
   // YENÄ°: YayÄ±nlanmÄ±ÅŸ tepe listesi dokÃ¼manÄ± (latest)
   DocumentReference<Map<String, dynamic>> _leaderboardTopLatestDoc(String examType, String period)
-      => _firestore.collection('leaderboard_top').doc(examType).collection(period).doc('latest');
+  => _firestore.collection('leaderboard_top').doc(examType).collection(period).doc('latest');
   // YENÄ°: Optimize edilmiÅŸ anlÄ±k gÃ¶rÃ¼ntÃ¼ dokÃ¼manÄ± referansÄ±
   DocumentReference<Map<String, dynamic>> _leaderboardSnapshotDoc(String examType, String period)
-      => _firestore.collection('leaderboard_snapshots').doc('${examType}_$period');
+  => _firestore.collection('leaderboard_snapshots').doc('${examType}_$period');
   // YENÄ°: Public profile dokÃ¼manÄ±
   DocumentReference<Map<String, dynamic>> _publicProfileDoc(String userId)
-      => _firestore.collection('public_profiles').doc(userId);
+  => _firestore.collection('public_profiles').doc(userId);
 
   // Admin: rapor indeks akÄ±ÅŸÄ± (en Ã§ok raporlananlar en Ã¼stte)
   Stream<List<Map<String, dynamic>>> streamQuestionReportIndex({int limit = 200}) {
@@ -177,16 +177,16 @@ class FirestoreService {
 
     final Map<String, List<String>> out = {};
     for (final doc in qs.docs) {
-        final data = doc.data();
-        final taskId = data['taskId'] as String;
-        // The document ID of the parent is the dateKey
-        final dateKey = doc.reference.parent.parent!.id;
-
-        if (out.containsKey(dateKey)) {
-            out[dateKey]!.add(taskId);
-        } else {
-            out[dateKey] = [taskId];
-        }
+      final data = doc.data();
+      final taskId = data['taskId'] as String;
+      // The document ID of the parent is the dateKey
+      final dateKey = doc.reference.parent.parent!.id;
+
+      if (out.containsKey(dateKey)) {
+        out[dateKey]!.add(taskId);
+      } else {
+        out[dateKey] = [taskId];
+      }
     }
     return out;
   }
@@ -206,11 +206,11 @@ class FirestoreService {
 
     final List<Timestamp> visits = [];
     for (final doc in qs.docs) {
-        final data = doc.data();
-        final visitTime = data['visitTime'] as Timestamp?;
-        if (visitTime != null) {
-            visits.add(visitTime);
-        }
+      final data = doc.data();
+      final visitTime = data['visitTime'] as Timestamp?;
+      if (visitTime != null) {
+        visits.add(visitTime);
+      }
     }
     return visits;
   }
@@ -265,9 +265,9 @@ class FirestoreService {
   DocumentReference<Map<String, dynamic>> _performanceDoc(String userId) => usersCollection.doc(userId).collection('performance').doc('summary');
   DocumentReference<Map<String, dynamic>> _appStateDoc(String userId) => usersCollection.doc(userId).collection('state').doc('app_state');
   DocumentReference<Map<String, dynamic>> _leaderboardUserDoc({required String examType, required String userId}) => _leaderboardsCollection.doc(examType).collection('users').doc(userId);
-  // YENI: Konu performanslarÄ± iÃ§in alt koleksiyon
+  // YENÄ°: Konu performanslarÄ± iÃ§in alt koleksiyon
   CollectionReference<Map<String, dynamic>> _topicPerformanceCollection(String userId) => usersCollection.doc(userId).collection('topic_performance');
-  // YENI: UstalaÅŸÄ±lan konular iÃ§in alt koleksiyon
+  // YENÄ°: UstalaÅŸÄ±lan konular iÃ§in alt koleksiyon
   CollectionReference<Map<String, dynamic>> _masteredTopicsCollection(String userId) => _performanceDoc(userId).collection('masteredTopics');
 
   Future<void> _syncLeaderboardUser(String userId, {String? targetExam}) async {
@@ -335,7 +335,7 @@ class FirestoreService {
     }
   }
 
-  Future<void> saveWorkshopForUser(String userId, SavedWorkshopModel workshop) async {
+  Future<void> saveWorkshopForUser(String userId, WorkshopModel workshop) async {
     final userDocRef = usersCollection.doc(userId);
     final workshopCollectionRef = userDocRef.collection('savedWorkshops');
     await workshopCollectionRef.doc(workshop.id).set(workshop.toMap());
@@ -349,13 +349,46 @@ class FirestoreService {
         .delete();
   }
 
-  Stream<List<SavedWorkshopModel>> getSavedWorkshops(String userId) {
+  Stream<List<WorkshopModel>> getSavedWorkshops(String userId) {
     return usersCollection
         .doc(userId)
         .collection('savedWorkshops')
         .orderBy('savedDate', descending: true)
         .snapshots()
-        .map((snapshot) => snapshot.docs.map((doc) => SavedWorkshopModel.fromSnapshot(doc)).toList());
+        .map((snapshot) => snapshot.docs.map((doc) => WorkshopModel.fromSnapshot(doc)).toList());
+  }
+
+  /// KullanÄ±cÄ±nÄ±n workshop serisini (streak) gÃ¼nceller.
+  /// Ä°ÅŸ mantÄ±ÄŸÄ± (Business Logic) burada dÃ¶ner, UI sadece Ã§aÄŸÄ±rÄ±r.
+  Future<int> updateUserWorkshopStreak(String userId, Timestamp? lastWorkshopDate, int currentStreak) async {
+    final now = DateTime.now();
+    final today = DateTime(now.year, now.month, now.day);
+
+    int newStreak = currentStreak;
+
+    if (lastWorkshopDate == null) {
+      newStreak = 1;
+    } else {
+      final last = lastWorkshopDate.toDate();
+      final lastDay = DateTime(last.year, last.month, last.day);
+      final diff = today.difference(lastDay).inDays;
+
+      if (diff == 1) {
+        // DÃ¼n yapmÄ±ÅŸ, seri devam ediyor
+        newStreak += 1;
+      } else if (diff > 1) {
+        // Zinciri kÄ±rmÄ±ÅŸ, baÅŸtan baÅŸla
+        newStreak = 1;
+      }
+      // diff == 0 ise (bugÃ¼n zaten yapmÄ±ÅŸsa) streak deÄŸiÅŸmez.
+    }
+
+    await usersCollection.doc(userId).update({
+      'workshopStreak': newStreak,
+      'lastWorkshopDate': FieldValue.serverTimestamp(),
+    });
+
+    return newStreak;
   }
 
   Future<void> createUserProfile({
@@ -472,7 +505,7 @@ class FirestoreService {
   }
 
   // KULLANICI PROFÄ°LÄ° GÃœNCELLEME (BASÄ°TLEÅTÄ°RÄ°LDÄ°)
-  // Veri senkronizasyonu artÄ±k onUserUpdate Cloud Function'Ä± tarafÄ±ndan yapÄ±lÄ±yor.
+  // Veri senkronizasyonÄ± artÄ±k onUserUpdate Cloud Function'Ä± tarafÄ±ndan yapÄ±lÄ±yor.
   Future<void> updateUserProfile(String userId, Map<String, dynamic> data) async {
     final userDocRef = usersCollection.doc(userId);
 
@@ -614,15 +647,70 @@ class FirestoreService {
     return qs.docs.map((d) => TestModel.fromSnapshot(d as DocumentSnapshot<Map<String, dynamic>>)).toList();
   }
 
-  // Test silme fonksiyonu
+  // YENI: Herhangi bir kullanÄ±cÄ±nÄ±n testlerini sayfalÄ± olarak getir (public profile streak gibi yerlerde kullanÄ±lÄ±r)
+  Future<List<TestModel>> getTestResultsPaginatedForUser(String userId, {DocumentSnapshot? lastVisible, int limit = 120}) async {
+    Query query = _testsCollection
+        .where('userId', isEqualTo: userId)
+        .orderBy('date', descending: true)
+        .limit(limit);
+
+    if (lastVisible != null) {
+      query = query.startAfterDocument(lastVisible);
+    }
+
+    final qs = await query.get();
+    return qs.docs.map((d) => TestModel.fromSnapshot(d as DocumentSnapshot<Map<String, dynamic>>)).toList();
+  }
+
+  // Test silme fonksiyonu - GÃœNCELLENDÄ°: Ä°statistikleri anÄ±nda dÃ¼ÅŸÃ¼rÃ¼r ve public profile'Ä± senkronize eder.
   Future<void> deleteTest(String testId) async {
+    final currentUserId = getUserId();
+    if (currentUserId == null) throw Exception('KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil');
+
+    final docRef = _testsCollection.doc(testId);
+    final docSnap = await docRef.get();
+
+    if (!docSnap.exists) return; // Zaten silinmiÅŸ
+
+    final data = docSnap.data();
+    if (data == null) return;
+
+    // GÃ¼venlik: Sadece kendi testini silebilir
+    if (data['userId'] != currentUserId) {
+      throw Exception('Bu iÅŸlem iÃ§in yetkiniz yok');
+    }
+
+    final double netToRemove = (data['totalNet'] as num?)?.toDouble() ?? 0.0;
+
+    final batch = _firestore.batch();
+    batch.delete(docRef);
+
+    // Stats gÃ¼ncelle: Deneme sayÄ±sÄ± ve toplam neti dÃ¼ÅŸÃ¼r
+    final statsRef = _userStatsDoc(currentUserId);
+    batch.set(statsRef, {
+      'testCount': FieldValue.increment(-1),
+      'totalNetSum': FieldValue.increment(-netToRemove),
+      'updatedAt': FieldValue.serverTimestamp(),
+    }, SetOptions(merge: true));
+
+    await batch.commit();
+
+    // Public profile'Ä± senkronize et
     try {
-      await _testsCollection.doc(testId).delete();
-      // Not: Ä°statistiklerin gÃ¼ncellenmesi (test sayÄ±sÄ±nÄ±n dÃ¼ÅŸmesi vb.)
-      // genellikle arka planda bir Firestore Trigger (Cloud Function) tarafÄ±ndan yÃ¶netilmelidir.
+      // Stats'tan gÃ¼ncel deÄŸerleri al
+      final statsSnap = await statsRef.get();
+      final stats = statsSnap.data() ?? {};
+
+      // Public profile'Ä± gÃ¼ncelle
+      final publicProfileRef = _publicProfileDoc(currentUserId);
+      await publicProfileRef.set({
+        'testCount': stats['testCount'] ?? 0,
+        'totalNetSum': stats['totalNetSum'] ?? 0,
+        'updatedAt': FieldValue.serverTimestamp(),
+      }, SetOptions(merge: true));
     } catch (e) {
-      debugPrint('Test silme hatasÄ±: $e');
-      rethrow;
+      // Public profile gÃ¼ncellemesi baÅŸarÄ±sÄ±z olsa bile devam et
+      // (KullanÄ±cÄ± deneyimini etkilemesin)
     }
   }
 
@@ -762,24 +850,64 @@ class FirestoreService {
     required String pacing,
     required Map<String, dynamic> weeklyPlan,
   }) async {
-    // CreationDate ekle (eÄŸer yoksa)
-    // FieldValue.serverTimestamp() KULLANMA! UI patlar (Type Mismatch)
-    // Prompt zaten creationDate Ã¼retiyor, yoksa ÅŸimdi String olarak ekle
+    // 1. CreationDate kontrolÃ¼
     if (!weeklyPlan.containsKey('creationDate') || weeklyPlan['creationDate'] == null) {
       weeklyPlan['creationDate'] = DateTime.now().toIso8601String();
     }
 
-    // âœ… KRÄ°TÄ°K DÃœZELTME: Yeni plan geldiÄŸinde eski tamamlanan gÃ¶revleri sÄ±fÄ±rla!
-    // Aksi halde eski plandaki taskId'ler yeni planda da tamamlanmÄ±ÅŸ gibi gÃ¶zÃ¼kÃ¼r ("ghost completion")
-    await _planDoc(userId).set({
+    final planRef = _planDoc(userId);
+    final historyCollection = usersCollection.doc(userId).collection('archived_plans');
+
+    // 2. MEVCUT PLANI ARÅÄ°VLEME MANTIÄI
+    final currentSnap = await planRef.get();
+    if (currentSnap.exists && currentSnap.data() != null) {
+      final currentData = currentSnap.data()!;
+      // EÄŸer iÃ§inde geÃ§erli bir plan varsa arÅŸivle
+      if (currentData['weeklyPlan'] != null) {
+        // ArÅŸiv belgesi iÃ§in ID olarak creationDate timestamp veya ÅŸimdiki zamanÄ± kullan
+        final archiveId = DateTime.now().millisecondsSinceEpoch.toString();
+
+        // ArÅŸive kaydet
+        await historyCollection.doc(archiveId).set({
+          ...currentData,
+          'archivedAt': FieldValue.serverTimestamp(),
+        });
+      }
+    }
+
+    // 3. ARÅÄ°V LÄ°MÄ°TÄ° KONTROLÃœ (Son 5 Plan)
+    final historySnap = await historyCollection.orderBy('archivedAt', descending: true).get();
+    if (historySnap.docs.length > 4) { // 5. yi ekledik, o yÃ¼zden 4'ten bÃ¼yÃ¼kse fazlalarÄ± sil
+      final docsToDelete = historySnap.docs.sublist(4); // Ä°lk 5 hariÃ§ gerisini al
+      final batch = _firestore.batch();
+      for (var doc in docsToDelete) {
+        batch.delete(doc.reference);
+      }
+      await batch.commit();
+    }
+
+    // 4. YENÄ° PLANI KAYDET (Eski tamamlama verilerini sÄ±fÄ±rlayarak)
+    await planRef.set({
       'studyPacing': pacing,
       'weeklyPlan': weeklyPlan,
-      'completedTasks': [], // ğŸ‘ˆ Ä°ÅŸte bu! TamamlanmÄ±ÅŸ gÃ¶revleri sÄ±fÄ±rla
+      'completedTasks': [], // TamamlanmÄ±ÅŸ gÃ¶revleri sÄ±fÄ±rla
       'lastUpdated': FieldValue.serverTimestamp(),
     }, SetOptions(merge: true));
+
     await updateEngagementScore(userId, 100);
   }
 
+  // YENÄ° EKLENECEK METOT: ArÅŸivlenmiÅŸ planlarÄ± getir
+  Stream<List<PlanDocument>> getArchivedPlansStream(String userId) {
+    return usersCollection
+        .doc(userId)
+        .collection('archived_plans')
+        .orderBy('archivedAt', descending: true)
+        .limit(5)
+        .snapshots()
+        .map((qs) => qs.docs.map((d) => PlanDocument.fromSnapshot(d)).toList());
+  }
+
   Future<void> markTopicAsMastered({required String userId, required String subject, required String topic}) async {
     final sanitizedSubject = sanitizeKey(subject);
     final sanitizedTopic = sanitizeKey(topic);
@@ -817,38 +945,24 @@ class FirestoreService {
   }
 
   // YENÄ°: Public profile oku (gÃ¼venli alanlar)
+  // GÃœNCEL: ArtÄ±k kendi profilimde de public_profiles tek kaynak (server-side doÄŸru hesaplanÄ±yor)
   Future<Map<String, dynamic>?> getPublicProfileRaw(String userId) async {
-    // 1. Ã–nce Public Profile'a bak (En hÄ±zlÄ± ve doÄŸru yÃ¶ntem)
+    final currentUid = getUserId();
+
+    // 1. Public Profile'a bak (Cache dostu) - kendi profilimde de burasÄ± kullanÄ±lÄ±r
     final snap = await _publicProfileDoc(userId).get();
     if (snap.exists) return snap.data();
 
-    // 2. EÄŸer kendi profilimse, users koleksiyonundan okuyabilirim (Fallback)
-    // BaÅŸkasÄ±nÄ±n 'users' dokÃ¼manÄ±nÄ± okumak YASAKTIR (Permission Denied verir).
-    final currentUid = getUserId();
-    if (userId == currentUid) {
-      try {
-        final userSnap = await usersCollection.doc(userId).get();
-        if (!userSnap.exists) return null;
-
-        final u = userSnap.data() ?? <String, dynamic>{};
-        final statsSnap = await _userStatsDoc(userId).get();
-        final s = statsSnap.data() ?? const <String, dynamic>{};
-
-        return <String, dynamic>{
-          'name': (u['name'] ?? '') as String,
-          'testCount': ((s['testCount'] ?? u['testCount'] ?? 0) as num).toInt(),
-          'totalNetSum': ((s['totalNetSum'] ?? u['totalNetSum'] ?? 0.0) as num).toDouble(),
-          'engagementScore': ((s['engagementScore'] ?? u['engagementScore'] ?? 0) as num).toInt(),
-          'streak': ((s['streak'] ?? u['streak'] ?? 0) as num).toInt(),
-          'avatarStyle': u['avatarStyle'] as String?,
-          'avatarSeed': u['avatarSeed'] as String?,
-        };
-      } catch (_) {
-        return null;
-      }
+    // 2. Fallback: Leaderboard verisi (EÄŸer public profile yoksa, Ã¶rn. eski kullanÄ±cÄ±)
+    // BaÅŸkasÄ±nÄ±n 'users' dokÃ¼manÄ±nÄ± okumak YASAKTIR; kendi profilimde ise users okunabilir ama public_profile yoksa leaderboard deneriz.
+    String? myExam;
+    if (currentUid != null) {
+      myExam = (await usersCollection.doc(currentUid).get()).data()?['selectedExam'] as String?;
+    }
+    if (myExam != null) {
+      return await getLeaderboardUserRaw(myExam, userId);
     }
 
-    // BaÅŸkasÄ±ysa ve public profile yoksa, kullanÄ±cÄ± silinmiÅŸ demektir.
     return null;
   }
 
@@ -1171,10 +1285,10 @@ class FirestoreService {
 
   /// TakipÃ§ileri parÃ§a parÃ§a getirir
   Future<(List<String> ids, DocumentSnapshot? lastDoc)> getFollowersPaginated(
-    String userId, {
-    int limit = 20,
-    DocumentSnapshot? startAfter,
-  }) async {
+      String userId, {
+        int limit = 20,
+        DocumentSnapshot? startAfter,
+      }) async {
     Query query = _followersCollection(userId)
         .orderBy('createdAt', descending: true) // En yeni takipÃ§iler Ã¼stte
         .limit(limit);
@@ -1192,10 +1306,10 @@ class FirestoreService {
 
   /// Takip edilenleri parÃ§a parÃ§a getirir
   Future<(List<String> ids, DocumentSnapshot? lastDoc)> getFollowingPaginated(
-    String userId, {
-    int limit = 20,
-    DocumentSnapshot? startAfter,
-  }) async {
+      String userId, {
+        int limit = 20,
+        DocumentSnapshot? startAfter,
+      }) async {
     Query query = _followingCollection(userId)
         .orderBy('createdAt', descending: true)
         .limit(limit);
@@ -1421,5 +1535,27 @@ class FirestoreService {
     }
   }
 
-  // KALDIRILDI: resetUserDataForNewExam() - ArtÄ±k kullanÄ±lmÄ±yor
+  /// GerÃ§ek deneme sayÄ±sÄ± (tests koleksiyonundan). Stats/cache drift ederse bile doÄŸruyu verir.
+  /// Not: Aggregate count yerine snapshot boyutu kullanÄ±lÄ±r; tek kullanÄ±cÄ± iÃ§in kabul edilebilir maliyet.
+  Stream<int> streamTestCount(String userId) {
+    return _testsCollection
+        .where('userId', isEqualTo: userId)
+        .snapshots()
+        .map((qs) => qs.size);
+  }
+
+  /// GerÃ§ek toplam net (tests koleksiyonundan). Stats/cache drift ederse bile doÄŸruyu verir.
+  Stream<double> streamTotalNetSum(String userId) {
+    return _testsCollection
+        .where('userId', isEqualTo: userId)
+        .snapshots()
+        .map((qs) {
+          double sum = 0.0;
+          for (final d in qs.docs) {
+            final data = d.data();
+            sum += (data['totalNet'] as num?)?.toDouble() ?? 0.0;
+          }
+          return sum;
+        });
+  }
 }
diff --git a/lib/features/home/logic/add_test_notifier.dart b/lib/features/home/logic/add_test_notifier.dart
index 4d13d13..e40ed62 100644
--- a/lib/features/home/logic/add_test_notifier.dart
+++ b/lib/features/home/logic/add_test_notifier.dart
@@ -3,22 +3,30 @@ import 'package:equatable/equatable.dart';
 import 'package:flutter_riverpod/flutter_riverpod.dart';
 import 'package:taktik/data/models/exam_model.dart';
 
-// 1. Bu Ã¶zelliÄŸin tÃ¼m durumunu tutan "hafÄ±za" modeli
+// STATE
 class AddTestState extends Equatable {
   final int currentStep;
   final String testName;
   final List<ExamSection> availableSections;
-  final ExamSection? selectedSection;
+  final ExamSection? selectedSection; // Genel seÃ§im (TYT, YDT vb.)
+  final ExamSection? activeSection;   // Net girilecek asÄ±l nesne (Sadece Mat olabilir veya tÃ¼m TYT)
   final Map<String, Map<String, int>> scores;
   final bool isSaving;
 
+  // BranÅŸ Modu deÄŸiÅŸkenleri
+  final bool isBranchMode;
+  final String? selectedBranchSubject;
+
   const AddTestState({
     this.currentStep = 0,
     this.testName = '',
     this.availableSections = const [],
     this.selectedSection,
+    this.activeSection,
     this.scores = const {},
     this.isSaving = false,
+    this.isBranchMode = false,
+    this.selectedBranchSubject,
   });
 
   AddTestState copyWith({
@@ -26,51 +34,54 @@ class AddTestState extends Equatable {
     String? testName,
     List<ExamSection>? availableSections,
     ExamSection? selectedSection,
+    ExamSection? activeSection,
     Map<String, Map<String, int>>? scores,
     bool? isSaving,
+    bool? isBranchMode,
+    String? selectedBranchSubject,
   }) {
     return AddTestState(
       currentStep: currentStep ?? this.currentStep,
       testName: testName ?? this.testName,
       availableSections: availableSections ?? this.availableSections,
       selectedSection: selectedSection ?? this.selectedSection,
+      activeSection: activeSection ?? this.activeSection,
       scores: scores ?? this.scores,
       isSaving: isSaving ?? this.isSaving,
+      isBranchMode: isBranchMode ?? this.isBranchMode,
+      selectedBranchSubject: selectedBranchSubject ?? this.selectedBranchSubject,
     );
   }
 
   @override
-  List<Object?> get props => [currentStep, testName, availableSections, selectedSection, scores, isSaving];
+  List<Object?> get props => [
+    currentStep, testName, availableSections, selectedSection,
+    activeSection, scores, isSaving, isBranchMode, selectedBranchSubject
+  ];
 }
 
 
-// 2. Bu "hafÄ±zayÄ±" yÃ¶neten "beyin" (Notifier)
+// NOTIFIER
 class AddTestNotifier extends StateNotifier<AddTestState> {
   AddTestNotifier() : super(const AddTestState());
 
-  // Komut: SÄ±nav verisi yÃ¼klendi, durumu baÅŸlat.
-  // DEÄÄ°ÅÄ°KLÄ°K: LGS iÃ§in Ã¶zel mantÄ±k eklendi.
   void initialize(List<ExamSection> sections, ExamType examType) {
-    // EÄŸer sÄ±nav LGS ise ve birden fazla bÃ¶lÃ¼m iÃ§eriyorsa (SÃ¶zel, SayÄ±sal)...
+    // LGS mantÄ±ÄŸÄ± (Tek bÃ¶lÃ¼m gibi davran)
     if (examType == ExamType.lgs && sections.length > 1) {
-      // ...tÃ¼m dersleri tek bir haritada birleÅŸtir.
       final Map<String, SubjectDetails> combinedSubjects = {};
       for (var section in sections) {
         combinedSubjects.addAll(section.subjects);
       }
-      // "LGS" adÄ±nda yeni, birleÅŸik bir sanal bÃ¶lÃ¼m oluÅŸtur.
       final combinedSection = ExamSection(
-        name: 'LGS', // ArtÄ±k tek bir isim var.
+        name: 'LGS',
         subjects: combinedSubjects,
         penaltyCoefficient: sections.first.penaltyCoefficient,
       );
-      // Durumu, sadece bu birleÅŸik bÃ¶lÃ¼mÃ¼ iÃ§erecek ÅŸekilde gÃ¼ncelle.
       state = state.copyWith(
         availableSections: [combinedSection],
-        selectedSection: combinedSection, // Ve otomatik olarak seÃ§.
+        selectedSection: combinedSection,
       );
     } else {
-      // DiÄŸer sÄ±navlar iÃ§in eski mantÄ±k devam ediyor.
       state = state.copyWith(availableSections: sections);
       if (sections.length == 1) {
         state = state.copyWith(selectedSection: sections.first);
@@ -78,40 +89,113 @@ class AddTestNotifier extends StateNotifier<AddTestState> {
     }
   }
 
-  // Komut: Test adÄ±nÄ± gÃ¼ncelle.
   void setTestName(String name) {
     state = state.copyWith(testName: name);
   }
 
-  // Komut: BÃ¶lÃ¼m seÃ§.
   void setSection(ExamSection? section) {
-    state = state.copyWith(selectedSection: section);
+    state = state.copyWith(
+      selectedSection: section,
+      selectedBranchSubject: null, // BÃ¶lÃ¼m deÄŸiÅŸince ders seÃ§imi sÄ±fÄ±rlanÄ±r
+    );
+  }
+
+  // BranÅŸ modunu aÃ§/kapa
+  void setBranchMode(bool isBranch) {
+    state = state.copyWith(
+      isBranchMode: isBranch,
+      selectedBranchSubject: null, // Mod deÄŸiÅŸince seÃ§im sÄ±fÄ±rlanÄ±r
+    );
+  }
+
+  // BranÅŸ iÃ§in ders seÃ§imi
+  void setBranchSubject(String subject) {
+    state = state.copyWith(selectedBranchSubject: subject);
   }
 
-  // Komut: Bir sonraki adÄ±ma geÃ§.
   void nextStep() {
-    if (state.currentStep == 0) { // AdÄ±m 1'den 2'ye geÃ§erken
-      final section = state.selectedSection;
-      if (section != null) {
+    if (state.currentStep == 0) {
+      // AdÄ±m 1'den 2'ye geÃ§erken Active Section'Ä± oluÅŸtur
+      final baseSection = state.selectedSection;
+
+      if (baseSection != null) {
+        ExamSection targetSection;
+
+        // 1. GENEL DENEME ZORLAMASI (Main Exam Force)
+        // EÄŸer seÃ§ilen bÃ¶lÃ¼mÃ¼n altÄ±nda sadece 1 ders varsa (Ã–rn: Tekli Alan Bilgisi, YDT),
+        // kullanÄ±cÄ± "BranÅŸ" seÃ§miÅŸ olsa bile bu bir "Ana SÄ±nav" (Genel Deneme) kabul edilir.
+        bool forceToGeneral = baseSection.subjects.length == 1;
+
+        // 2. BRANÅ DENEMESÄ° ZORLAMASI (Branch Exam Force)
+        // DÃœZELTME: SÄ±nÄ±f Ã–ÄŸretmenliÄŸi, Okul Ã–ncesi ve Ã–zel EÄŸitim gibi bÃ¶lÃ¼mler
+        // birden fazla dersten (Alan + EÄŸitim) oluÅŸur ama tek bir "Genel Deneme"dir.
+        // Bu yÃ¼zden bu zorlamayÄ± kaldÄ±rÄ±yoruz. KullanÄ±cÄ± "Genel Deneme" seÃ§tiyse
+        // (isBranchMode: false), tÃ¼m bÃ¶lÃ¼mÃ¼ tek bir sÄ±nav olarak gÃ¶rmelidir.
+
+        // Ä°PTAL EDÄ°LEN ESKÄ° MANTIK:
+        /*
+        final subjectKeys = baseSection.subjects.keys.toList();
+        bool hasOABTSubjects = subjectKeys.any((key) =>
+        key.contains('Alan Bilgisi') ||
+            key.contains('Alan EÄŸitimi') ||
+            key.contains('Temel Alan Bilgisi'));
+
+        bool forceToBranch = !forceToGeneral && hasOABTSubjects;
+        */
+
+        // DÃœZELTÄ°LMÄ°Å MANTIK:
+        // EÄŸer bÃ¶lÃ¼m birden fazla ders iÃ§eriyorsa (SÄ±nÄ±f Ã–ÄŸretmenliÄŸi gibi),
+        // bunu otomatik olarak branÅŸ denemesine Ã§evirme.
+        // KullanÄ±cÄ±nÄ±n en baÅŸtaki seÃ§imine (isBranchMode) sadÄ±k kal.
+        bool forceToBranch = false;
+
+        // Target Section Belirleme
+        // BranÅŸ moduysa (veya zorlandÄ±ysa) VE belirli bir ders seÃ§ildiyse -> O dersi tek Ã§ek
+        if ((state.isBranchMode || forceToBranch) && state.selectedBranchSubject != null && !forceToGeneral) {
+          final subjectName = state.selectedBranchSubject!;
+          final subjectDetails = baseSection.subjects[subjectName]!;
+
+          targetSection = ExamSection(
+              name: subjectName, // BranÅŸ ismi (Ã¶rn: Matematik)
+              subjects: {subjectName: subjectDetails}, // Sadece seÃ§ilen ders
+              penaltyCoefficient: baseSection.penaltyCoefficient,
+              availableLanguages: baseSection.availableLanguages
+          );
+        } else {
+          // Normal mod (Genel Deneme) veya Tek dersli sÄ±nav -> TÃœM BÃ–LÃœM
+          // SÄ±nÄ±f Ã–ÄŸretmenliÄŸi burada "baseSection" olarak (tÃ¼m dersleriyle) kalÄ±r.
+          targetSection = baseSection;
+        }
+
+        // Puan haritasÄ±nÄ± sÄ±fÄ±rla
         final initialScores = {
-          for (var subject in section.subjects.keys)
+          for (var subject in targetSection.subjects.keys)
             subject: {'dogru': 0, 'yanlis': 0}
         };
-        state = state.copyWith(scores: initialScores, currentStep: 1);
+
+        // Final Mod KararÄ±:
+        // 1. Tek ders ise -> Genel Deneme (forceToGeneral -> isBranchMode: false)
+        // 2. Ã‡oklu Ã–ABT dersi ise -> KullanÄ±cÄ±nÄ±n seÃ§imi (state.isBranchMode) geÃ§erli.
+        bool finalIsBranchMode = forceToGeneral ? false : (forceToBranch ? true : state.isBranchMode);
+
+        state = state.copyWith(
+          scores: initialScores,
+          currentStep: 1,
+          activeSection: targetSection, // Step 2'de bunu kullanacaÄŸÄ±z
+          isBranchMode: finalIsBranchMode,
+        );
       }
     } else if (state.currentStep < 2) {
       state = state.copyWith(currentStep: state.currentStep + 1);
     }
   }
 
-  // Komut: Ã–nceki adÄ±ma dÃ¶n.
   void previousStep() {
     if (state.currentStep > 0) {
       state = state.copyWith(currentStep: state.currentStep - 1);
     }
   }
 
-  // Komut: PuanlarÄ± gÃ¼ncelle.
   void updateScores(String subject, {int? correct, int? wrong}) {
     final currentScores = Map<String, Map<String, int>>.from(state.scores);
     final subjectScores = Map<String, int>.from(currentScores[subject]!);
@@ -123,13 +207,11 @@ class AddTestNotifier extends StateNotifier<AddTestState> {
     state = state.copyWith(scores: currentScores);
   }
 
-  // Komut: Kaydetme durumunu deÄŸiÅŸtir.
   void setSaving(bool isSaving) {
     state = state.copyWith(isSaving: isSaving);
   }
 }
 
-// 3. Bu beyni tÃ¼m birimlerin kullanmasÄ±nÄ± saÄŸlayan "telsiz frekansÄ±" (Provider)
 final addTestProvider = StateNotifierProvider.autoDispose<AddTestNotifier, AddTestState>((ref) {
   return AddTestNotifier();
 });
\ No newline at end of file
diff --git a/lib/features/home/screens/library_screen.dart b/lib/features/home/screens/library_screen.dart
index 38e6a3f..4d631c1 100644
--- a/lib/features/home/screens/library_screen.dart
+++ b/lib/features/home/screens/library_screen.dart
@@ -4,6 +4,7 @@ import 'package:flutter_riverpod/flutter_riverpod.dart';
 import 'package:go_router/go_router.dart';
 import 'package:intl/intl.dart';
 import 'package:taktik/data/models/test_model.dart';
+import 'package:taktik/data/models/exam_model.dart';
 import 'package:taktik/data/providers/firestore_providers.dart';
 import 'package:taktik/data/providers/premium_provider.dart';
 import 'package:taktik/data/providers/temporary_access_provider.dart';
@@ -26,12 +27,11 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
   final List<TestModel> _tests = [];
   bool _isLoading = false;
   bool _hasMore = true;
-  static const int _pageSize = 10; // 20 -> 10
-  DocumentSnapshot? _lastVisible; // UI tarafÄ±nda dokÃ¼man referansÄ± tutacaÄŸÄ±z
+  static const int _pageSize = 10;
+  DocumentSnapshot? _lastVisible;
 
-  // YENI: UI durumlarÄ±
   String _searchQuery = '';
-  String _selectedSection = 'TÃ¼mÃ¼';
+  String _selectedCategory = 'TÃ¼mÃ¼';
   _SortOption _sortOption = const _SortOption(field: _SortField.date, descending: true);
 
   @override
@@ -39,7 +39,6 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
     super.initState();
     _scrollController.addListener(_onScroll);
     _loadInitial();
-    // Engagement: KÃ¼tÃ¼phane ziyareti eylemini bildir
     WidgetsBinding.instance.addPostFrameCallback((_){
       if (!mounted) return;
       ref.read(questNotifierProvider.notifier).userVisitedLibrary();
@@ -76,7 +75,6 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
     final userId = service.getUserId();
     if (userId == null) return;
 
-    // Sadece showLoader true ise (ilk aÃ§Ä±lÄ±ÅŸta) yÃ¼kleniyor iÅŸaretini aÃ§
     if (showLoader) {
       setState(() => _isLoading = true);
     }
@@ -90,7 +88,6 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
       });
       await _syncLastVisibleFromLastItem();
     } finally {
-      // YÃ¼kleme iÅŸareti aÃ§Ä±ksa kapat
       if (showLoader && mounted) {
         setState(() => _isLoading = false);
       }
@@ -104,7 +101,6 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
     if (userId == null) return;
     setState(() => _isLoading = true);
     try {
-      // _lastVisible yoksa senkronize et
       if (_lastVisible == null && _tests.isNotEmpty) {
         await _syncLastVisibleFromLastItem();
       }
@@ -123,101 +119,72 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
     }
   }
 
-  // Premium Renk Paleti
-  static const Color _colDeepBlue = Color(0xFF2E3192);
-  static const Color _colCyan = Color(0xFF1BFFFF);
+  // --- YARDIMCI METODLAR ---
 
-  @override
-  Widget build(BuildContext context) {
-    final textTheme = Theme.of(context).textTheme;
-    final theme = Theme.of(context);
-    final isDark = theme.brightness == Brightness.dark;
+  // AGS Ortak sÄ±nav bÃ¶lÃ¼mleri (Ã–ABT'den ayÄ±rt etmek iÃ§in)
+  static const _agsCommonSections = {
+    'Genel Yetenek',
+    'Genel KÃ¼ltÃ¼r ve EÄŸitim Bilgisi',
+    'AGS',
+    'AGS Ortak',
+  };
 
-    return Scaffold(
-      extendBodyBehindAppBar: true,
-      appBar: AppBar(
-        leading: IconButton(
-          icon: Icon(
-            Icons.arrow_back_ios_new_rounded,
-            size: 22,
-            color: theme.colorScheme.onSurface.withOpacity(0.9),
-          ),
-          onPressed: () {
-            if (context.canPop()) {
-              context.pop();
-            } else {
-              context.go('/home');
-            }
-          },
-        ),
-        title: Text(
-          'Deneme ArÅŸivi',
-          style: theme.textTheme.titleMedium?.copyWith(
-            fontWeight: FontWeight.w800,
-            fontSize: 17,
-            letterSpacing: 0.5,
-          ),
-        ),
-        centerTitle: true,
-        backgroundColor: Colors.transparent,
-        elevation: 0,
-        flexibleSpace: ClipRect(
-          child: BackdropFilter(
-            filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
-            child: Container(color: Colors.transparent),
-          ),
-        ),
-        actions: [
-          IconButton(
-            tooltip: 'SÄ±rala',
-            icon: Icon(
-              Icons.sort_rounded,
-              color: theme.colorScheme.onSurface.withOpacity(0.9),
-            ),
-            onPressed: _showSortSheet,
-          ),
-        ],
-      ),
-      backgroundColor: theme.scaffoldBackgroundColor,
-      body: Stack(
-        children: [
-          // Arka Plan Gradient
-          Container(
-            decoration: BoxDecoration(
-              gradient: RadialGradient(
-                center: const Alignment(0, -0.8),
-                radius: 1.6,
-                colors: isDark
-                    ? [
-                        _colDeepBlue.withOpacity(0.12),
-                        theme.scaffoldBackgroundColor,
-                      ]
-                    : [
-                        _colCyan.withOpacity(0.08),
-                        theme.scaffoldBackgroundColor,
-                      ],
-                stops: const [0.0, 1.0],
-              ),
-            ),
-          ),
-          // Ä°Ã§erik
-          _buildBody(textTheme),
-        ],
-      ),
-    );
+  // Filtreleme iÃ§in kategori belirleme (UI'da gÃ¶stermiyoruz ama filtrede kullanÄ±yoruz)
+  String _getDisplayCategory(TestModel test) {
+    if (test.isBranchTest) {
+      return test.smartDisplayName; // "TÃ¼rkÃ§e", "Matematik" vb.
+    }
+
+    // AGS - Ã–ABT ayrÄ±mÄ±
+    if (test.examType == ExamType.ags) {
+      // sectionName AGS ortak bÃ¶lÃ¼mlerinden biri mi kontrol et
+      if (_agsCommonSections.contains(test.sectionName)) {
+        return 'AGS';
+      }
+      // DeÄŸilse Ã–ABT branÅŸÄ±
+      return 'Ã–ABT';
+    }
+
+    // YKS - TYT/AYT ayrÄ±mÄ±
+    if (test.examType == ExamType.yks) {
+      final sectionUpper = test.sectionName.toUpperCase();
+      final testNameUpper = test.testName.toUpperCase();
+
+      // sectionName'e gÃ¶re TYT mi AYT mi kontrol et
+      if (sectionUpper.contains('TYT')) {
+        return 'TYT';
+      } else if (sectionUpper.contains('AYT')) {
+        return 'AYT';
+      } else if (sectionUpper.contains('YDT')) { // - YDT kontrolÃ¼ eklendi
+        return 'YDT';
+      }
+
+      // EÄŸer sectionName'de bulamazsak, testName'e bakalÄ±m
+      if (testNameUpper.contains('TYT')) {
+        return 'TYT';
+      } else if (testNameUpper.contains('AYT')) {
+        return 'AYT';
+      } else if (testNameUpper.contains('YDT')) { // - YDT kontrolÃ¼ eklendi
+        return 'YDT';
+      }
+    }
+
+    // Ana deneme ise SÄ±nav TÃ¼rÃ¼nÃ¼ kullan (Ã–rn: KPSS Lisans)
+    return test.examType.displayName;
   }
 
-  // YENI: Filtre/SÄ±ralama uygulayan yardÄ±mcÄ±
   List<TestModel> _applyFiltersAndSort() {
     Iterable<TestModel> list = _tests;
+
     // Arama
     if (_searchQuery.trim().isNotEmpty) {
       final q = _searchQuery.toLowerCase();
       list = list.where((t) => t.testName.toLowerCase().contains(q));
     }
-    // BÃ¶lÃ¼m filtresi
-    if (_selectedSection != 'TÃ¼mÃ¼') {
-      list = list.where((t) => t.sectionName == _selectedSection);
+
+    // Kategori filtresi
+    if (_selectedCategory != 'TÃ¼mÃ¼') {
+      list = list.where((t) => _getDisplayCategory(t) == _selectedCategory);
     }
 
     var tmp = list.toList();
@@ -243,21 +210,20 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
   }
 
   double _accuracy(TestModel t) {
-    // DoÄŸruluk: boÅŸ sorular da yÃ¼zdelik hesabÄ±nda paydada yer almalÄ±.
-    // Ã–nceki hali: correct/(correct+wrong) -> boÅŸlar %'yi ÅŸiÅŸiriyordu.
     final total = t.totalCorrect + t.totalWrong + t.totalBlank;
-    if (total == 0) return 0.0; // HiÃ§ soru yoksa 0%
+    if (total == 0) return 0.0;
     return (t.totalCorrect / total) * 100.0;
   }
 
-  // YENI: Mevcut bÃ¶lÃ¼mler
-  List<String> _availableSections() {
-    final set = <String>{}..addAll(_tests.map((e) => e.sectionName));
+  List<String> _availableCategories() {
+    final set = <String>{};
+    for (final t in _tests) {
+      set.add(_getDisplayCategory(t));
+    }
     final list = set.toList()..sort();
     return ['TÃ¼mÃ¼', ...list];
   }
 
-  // YENI: SÄ±ralama alt sayfasÄ±
   void _showSortSheet() {
     showModalBottomSheet(
       context: context,
@@ -306,10 +272,94 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
     return Icon(_sortOption.descending ? Icons.south_rounded : Icons.north_rounded, color: Theme.of(context).colorScheme.primary);
   }
 
+  static const Color _colDeepBlue = Color(0xFF2E3192);
+  static const Color _colCyan = Color(0xFF1BFFFF);
+
+  @override
+  Widget build(BuildContext context) {
+    final textTheme = Theme.of(context).textTheme;
+    final theme = Theme.of(context);
+    final isDark = theme.brightness == Brightness.dark;
+
+    return Scaffold(
+      extendBodyBehindAppBar: true,
+      appBar: AppBar(
+        leading: IconButton(
+          icon: Icon(
+            Icons.arrow_back_ios_new_rounded,
+            size: 22,
+            color: theme.colorScheme.onSurface.withOpacity(0.9),
+          ),
+          onPressed: () {
+            if (context.canPop()) {
+              context.pop();
+            } else {
+              context.go('/home');
+            }
+          },
+        ),
+        title: Text(
+          'Deneme ArÅŸivi',
+          style: theme.textTheme.titleMedium?.copyWith(
+            fontWeight: FontWeight.w800,
+            fontSize: 17,
+            letterSpacing: 0.5,
+          ),
+        ),
+        centerTitle: true,
+        backgroundColor: Colors.transparent,
+        elevation: 0,
+        flexibleSpace: ClipRect(
+          child: BackdropFilter(
+            filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
+            child: Container(color: Colors.transparent),
+          ),
+        ),
+        actions: [
+          IconButton(
+            tooltip: 'SÄ±rala',
+            icon: Icon(
+              Icons.sort_rounded,
+              color: theme.colorScheme.onSurface.withOpacity(0.9),
+            ),
+            onPressed: _showSortSheet,
+          ),
+        ],
+      ),
+      backgroundColor: theme.scaffoldBackgroundColor,
+      body: Stack(
+        children: [
+          Container(
+            decoration: BoxDecoration(
+              gradient: RadialGradient(
+                center: const Alignment(0, -0.8),
+                radius: 1.6,
+                colors: isDark
+                    ? [
+                  _colDeepBlue.withOpacity(0.12),
+                  theme.scaffoldBackgroundColor,
+                ]
+                    : [
+                  _colCyan.withOpacity(0.08),
+                  theme.scaffoldBackgroundColor,
+                ],
+                stops: const [0.0, 1.0],
+              ),
+            ),
+          ),
+          _buildBody(textTheme),
+        ],
+      ),
+    );
+  }
+
   Widget _buildBody(TextTheme textTheme) {
     final theme = Theme.of(context);
     final isDark = theme.brightness == Brightness.dark;
 
+    // CihazÄ±n alt gÃ¼venli alan boÅŸluÄŸunu alÄ±yoruz
+    final bottomPadding = MediaQuery.of(context).padding.bottom;
+
     if (_tests.isEmpty && _isLoading) {
       return const LogoLoader();
     }
@@ -322,54 +372,23 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
             child: Column(
               mainAxisAlignment: MainAxisAlignment.center,
               children: [
-                // Lottie Animasyonu
                 Container(
-                  constraints: const BoxConstraints(
-                    maxWidth: 280,
-                    maxHeight: 280,
-                  ),
-                  child: Lottie.asset(
-                    'assets/lotties/empty.json',
-                    fit: BoxFit.contain,
-                    repeat: true,
-                  ),
-                ).animate()
-                  .fadeIn(duration: 500.ms)
-                  .scale(begin: const Offset(0.8, 0.8), duration: 600.ms, curve: Curves.easeOutBack),
-
+                  constraints: const BoxConstraints(maxWidth: 280, maxHeight: 280),
+                  child: Lottie.asset('assets/lotties/empty.json', fit: BoxFit.contain, repeat: true),
+                ).animate().fadeIn(duration: 500.ms).scale(begin: const Offset(0.8, 0.8), duration: 600.ms, curve: Curves.easeOutBack),
                 const SizedBox(height: 24),
-
-                // BaÅŸlÄ±k
                 Text(
                   'ArÅŸivin HenÃ¼z BoÅŸ',
-                  style: textTheme.titleLarge?.copyWith(
-                    fontWeight: FontWeight.w800,
-                    fontSize: 24,
-                    letterSpacing: -0.5,
-                  ),
+                  style: textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w800, fontSize: 24, letterSpacing: -0.5),
                   textAlign: TextAlign.center,
-                ).animate(delay: 200.ms)
-                  .fadeIn(duration: 400.ms)
-                  .slideY(begin: 0.1, duration: 500.ms),
-
+                ).animate(delay: 200.ms).fadeIn(duration: 400.ms).slideY(begin: 0.1, duration: 500.ms),
                 const SizedBox(height: 12),
-
-                // AÃ§Ä±klama
                 Text(
                   'Her deneme, gelecekteki baÅŸarÄ±nÄ±n bir kanÄ±tÄ±dÄ±r. Ä°lk kaydÄ±nÄ± ekleyerek yolculuÄŸuna baÅŸla ve geliÅŸimini takip et.',
                   textAlign: TextAlign.center,
-                  style: textTheme.bodyMedium?.copyWith(
-                    color: Theme.of(context).colorScheme.onSurfaceVariant,
-                    height: 1.5,
-                    fontSize: 15,
-                  ),
-                ).animate(delay: 300.ms)
-                  .fadeIn(duration: 400.ms)
-                  .slideY(begin: 0.1, duration: 500.ms),
-
+                  style: textTheme.bodyMedium?.copyWith(color: Theme.of(context).colorScheme.onSurfaceVariant, height: 1.5, fontSize: 15),
+                ).animate(delay: 300.ms).fadeIn(duration: 400.ms).slideY(begin: 0.1, duration: 500.ms),
                 const SizedBox(height: 32),
-
-                // Deneme Ekle Butonu - Premium Gradient Design (Dark Mode Optimized)
                 InkWell(
                   onTap: () => context.push('/home/add-test'),
                   borderRadius: BorderRadius.circular(20),
@@ -381,125 +400,58 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
                         begin: Alignment.topLeft,
                         end: Alignment.bottomRight,
                         colors: isDark
-                            ? [
-                                const Color(0xFF3D4DB7).withOpacity(0.35),
-                                const Color(0xFF1BFFFF).withOpacity(0.25),
-                              ]
-                            : [
-                                const Color(0xFF2E3192).withOpacity(0.08),
-                                const Color(0xFF1BFFFF).withOpacity(0.05),
-                              ],
+                            ? [const Color(0xFF3D4DB7).withOpacity(0.35), const Color(0xFF1BFFFF).withOpacity(0.25)]
+                            : [const Color(0xFF2E3192).withOpacity(0.08), const Color(0xFF1BFFFF).withOpacity(0.05)],
                       ),
                       borderRadius: BorderRadius.circular(20),
-                      border: Border.all(
-                        color: isDark
-                            ? const Color(0xFF1BFFFF).withOpacity(0.5)
-                            : const Color(0xFF2E3192).withOpacity(0.25),
-                        width: 2,
-                      ),
+                      border: Border.all(color: isDark ? const Color(0xFF1BFFFF).withOpacity(0.5) : const Color(0xFF2E3192).withOpacity(0.25), width: 2),
                       boxShadow: [
-                        BoxShadow(
-                          color: const Color(0xFF2E3192).withOpacity(isDark ? 0.4 : 0.15),
-                          blurRadius: 20,
-                          offset: const Offset(0, 8),
-                          spreadRadius: -2,
-                        ),
-                        BoxShadow(
-                          color: const Color(0xFF1BFFFF).withOpacity(isDark ? 0.35 : 0.2),
-                          blurRadius: 24,
-                          offset: const Offset(0, 12),
-                          spreadRadius: -4,
-                        ),
+                        BoxShadow(color: const Color(0xFF2E3192).withOpacity(isDark ? 0.4 : 0.15), blurRadius: 20, offset: const Offset(0, 8), spreadRadius: -2),
+                        BoxShadow(color: const Color(0xFF1BFFFF).withOpacity(isDark ? 0.35 : 0.2), blurRadius: 24, offset: const Offset(0, 12), spreadRadius: -4),
                       ],
                     ),
                     child: Column(
                       mainAxisSize: MainAxisSize.min,
                       children: [
-                        // Gradient Icon Container
                         Container(
                           padding: const EdgeInsets.all(18),
                           decoration: BoxDecoration(
                             gradient: LinearGradient(
-                              colors: isDark
-                                  ? [
-                                      const Color(0xFF4D5FD1),
-                                      const Color(0xFF1BFFFF),
-                                    ]
-                                  : [
-                                      const Color(0xFF2E3192),
-                                      const Color(0xFF1BFFFF),
-                                    ],
+                              colors: isDark ? [const Color(0xFF4D5FD1), const Color(0xFF1BFFFF)] : [const Color(0xFF2E3192), const Color(0xFF1BFFFF)],
                               begin: Alignment.topLeft,
                               end: Alignment.bottomRight,
                             ),
                             shape: BoxShape.circle,
                             boxShadow: [
-                              BoxShadow(
-                                color: const Color(0xFF2E3192).withOpacity(isDark ? 0.5 : 0.4),
-                                blurRadius: 16,
-                                offset: const Offset(0, 6),
-                              ),
-                              BoxShadow(
-                                color: const Color(0xFF1BFFFF).withOpacity(isDark ? 0.4 : 0.3),
-                                blurRadius: 20,
-                                offset: const Offset(0, 8),
-                                spreadRadius: -4,
-                              ),
+                              BoxShadow(color: const Color(0xFF2E3192).withOpacity(isDark ? 0.5 : 0.4), blurRadius: 16, offset: const Offset(0, 6)),
+                              BoxShadow(color: const Color(0xFF1BFFFF).withOpacity(isDark ? 0.4 : 0.3), blurRadius: 20, offset: const Offset(0, 8), spreadRadius: -4),
                             ],
                           ),
-                          child: const Icon(
-                            Icons.add_chart_rounded,
-                            color: Colors.white,
-                            size: 36,
-                          ),
+                          child: const Icon(Icons.add_chart_rounded, color: Colors.white, size: 36),
                         ),
                         const SizedBox(height: 18),
-                        // Gradient Text - Dark mode iÃ§in daha parlak
                         ShaderMask(
                           shaderCallback: (bounds) => LinearGradient(
-                            colors: isDark
-                                ? [
-                                    const Color(0xFF6B7FFF),
-                                    const Color(0xFF1BFFFF),
-                                  ]
-                                : [
-                                    const Color(0xFF2E3192),
-                                    const Color(0xFF1BFFFF),
-                                  ],
+                            colors: isDark ? [const Color(0xFF6B7FFF), const Color(0xFF1BFFFF)] : [const Color(0xFF2E3192), const Color(0xFF1BFFFF)],
                             begin: Alignment.topLeft,
                             end: Alignment.bottomRight,
                           ).createShader(bounds),
                           child: Text(
                             'Ä°lk Denemeni Ekle',
-                            style: textTheme.titleLarge?.copyWith(
-                              fontWeight: FontWeight.w900,
-                              fontSize: 22,
-                              letterSpacing: -0.5,
-                              color: Colors.white,
-                            ),
+                            style: textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900, fontSize: 22, letterSpacing: -0.5, color: Colors.white),
                             textAlign: TextAlign.center,
                           ),
                         ),
                         const SizedBox(height: 8),
                         Text(
                           'BaÅŸarÄ± yolculuÄŸunu arÅŸivlemeye baÅŸla',
-                          style: textTheme.bodyMedium?.copyWith(
-                            fontWeight: FontWeight.w600,
-                            fontSize: 14,
-                            height: 1.4,
-                            color: isDark
-                                ? Colors.white.withOpacity(0.85)
-                                : Colors.black.withOpacity(0.6),
-                          ),
+                          style: textTheme.bodyMedium?.copyWith(fontWeight: FontWeight.w600, fontSize: 14, height: 1.4, color: isDark ? Colors.white.withOpacity(0.85) : Colors.black.withOpacity(0.6)),
                           textAlign: TextAlign.center,
                         ),
                       ],
                     ),
                   ),
-                ).animate(delay: 400.ms)
-                  .fadeIn(duration: 500.ms)
-                  .slideY(begin: 0.15, duration: 600.ms, curve: Curves.easeOutCubic)
-                  .shimmer(delay: 800.ms, duration: 1500.ms),
+                ).animate(delay: 400.ms).fadeIn(duration: 500.ms).slideY(begin: 0.15, duration: 600.ms, curve: Curves.easeOutCubic).shimmer(delay: 800.ms, duration: 1500.ms),
               ],
             ),
           ),
@@ -509,11 +461,8 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
 
     final filtered = _applyFiltersAndSort();
 
-    final colorScheme = theme.colorScheme;
-
     return Column(
       children: [
-        // Arama ve filtre barÄ± - Premium tarzÄ±
         Padding(
           padding: EdgeInsets.fromLTRB(20, MediaQuery.of(context).padding.top + 70, 20, 0),
           child: Column(
@@ -554,8 +503,8 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
               SingleChildScrollView(
                 scrollDirection: Axis.horizontal,
                 child: Row(
-                  children: _availableSections().map((s) {
-                    final selected = _selectedSection == s;
+                  children: _availableCategories().map((s) {
+                    final selected = _selectedCategory == s;
                     return Padding(
                       padding: const EdgeInsets.only(right: 8.0),
                       child: FilterChip(
@@ -570,7 +519,7 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
                           ),
                         ),
                         selected: selected,
-                        onSelected: (_) => setState(() => _selectedSection = s),
+                        onSelected: (_) => setState(() => _selectedCategory = s),
                         backgroundColor: isDark ? const Color(0xFF1E2230) : Colors.white,
                         selectedColor: isDark
                             ? const Color(0xFF2E3192).withOpacity(0.2)
@@ -597,15 +546,14 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
           child: RefreshIndicator(
             onRefresh: () async {
               _lastVisible = null;
-              // showLoader: false gÃ¶nderiyoruz ki alttaki Ã§ark Ã§Ä±kmasÄ±n
               await _loadInitial(showLoader: false);
             },
             child: ListView.separated(
-              // Liste kÄ±sa olsa bile aÅŸaÄŸÄ± Ã§ekilmesine izin verir (RefreshIndicator iÃ§in gerekli)
               physics: const AlwaysScrollableScrollPhysics(),
               controller: _scrollController,
-              padding: const EdgeInsets.fromLTRB(20, 8, 20, 24),
-              // Sadece _isLoading true ve liste boÅŸ deÄŸilse alttaki Ã§ark iÃ§in yer ayÄ±r
+              // GÃœVENLÄ° ALAN DÃœZELTMESÄ°:
+              // Standart 24 padding'e ek olarak bottomPadding ekliyoruz.
+              padding: EdgeInsets.fromLTRB(20, 8, 20, 24 + bottomPadding),
               itemCount: filtered.length + (_isLoading && filtered.isNotEmpty ? 1 : 0),
               separatorBuilder: (_, __) => const SizedBox(height: 12),
               itemBuilder: (context, index) {
@@ -625,9 +573,13 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
                   );
                 }
                 final test = filtered[index];
-
-                // SektÃ¶r standardÄ± three-dots menÃ¼ yaklaÅŸÄ±mÄ±
-                return _ArchiveListTile(test: test);
+                return _ArchiveListTile(
+                  test: test,
+                  onDeleted: () async {
+                    _lastVisible = null;
+                    await _loadInitial(showLoader: false);
+                  },
+                );
               },
             ),
           ),
@@ -637,7 +589,6 @@ class _LibraryScreenState extends ConsumerState<LibraryScreen> {
   }
 }
 
-// YENI: SÄ±ralama seÃ§enekleri
 enum _SortField { date, net, accuracy }
 
 class _SortOption {
@@ -646,11 +597,14 @@ class _SortOption {
   const _SortOption({required this.field, required this.descending});
 }
 
-// SektÃ¶r standardÄ± liste Ã¶ÄŸesi (Three-dots menÃ¼ ile)
 class _ArchiveListTile extends ConsumerWidget {
   final TestModel test;
+  final VoidCallback onDeleted;
 
-  const _ArchiveListTile({required this.test});
+  const _ArchiveListTile({
+    required this.test,
+    required this.onDeleted,
+  });
 
   double _accuracy(TestModel t) {
     final total = t.totalCorrect + t.totalWrong + t.totalBlank;
@@ -658,16 +612,13 @@ class _ArchiveListTile extends ConsumerWidget {
     return (t.totalCorrect / total) * 100.0;
   }
 
-  // SavaÅŸ Raporuna (Ã–zet EkranÄ±) "ArÅŸivden geliyorum" sinyaliyle git
   void _goToWarReport(BuildContext context) {
-    // fromArchive=true parametresi, hedef ekranda geri tuÅŸunu aktifleÅŸtirecek
     context.push(
-      '/home/test-result-summary?fromArchive=true',
-      extra: test
+        '/home/test-result-summary?fromArchive=true',
+        extra: test
     );
   }
 
-  // ÅÄ±k bir Bottom Sheet (Alttan AÃ§Ä±lan MenÃ¼)
   void _showOptionsSheet(BuildContext context, WidgetRef ref) {
     final theme = Theme.of(context);
 
@@ -685,7 +636,6 @@ class _ArchiveListTile extends ConsumerWidget {
             child: Column(
               mainAxisSize: MainAxisSize.min,
               children: [
-                // BaÅŸlÄ±k kÄ±smÄ±
                 Padding(
                   padding: const EdgeInsets.symmetric(vertical: 8.0),
                   child: Text(
@@ -699,8 +649,6 @@ class _ArchiveListTile extends ConsumerWidget {
                   ),
                 ),
                 const Divider(),
-
-                // SEÃ‡ENEK 1: SavaÅŸ Raporu (Eski DetaylÄ± Analiz yerine)
                 ListTile(
                   leading: Container(
                     padding: const EdgeInsets.all(8),
@@ -710,15 +658,13 @@ class _ArchiveListTile extends ConsumerWidget {
                     ),
                     child: Icon(Icons.analytics_rounded, color: theme.colorScheme.primary),
                   ),
-                  title: const Text('SavaÅŸ Raporunu Ä°ncele'),
+                  title: const Text('Deneme Raporunu Ä°ncele'),
                   subtitle: const Text('Netlerini ve detaylÄ± analizini gÃ¶r'),
                   onTap: () {
                     Navigator.pop(ctx);
-                    _goToWarReport(context); // ArÅŸiv modunda SavaÅŸ Raporu'na git
+                    _goToWarReport(context);
                   },
                 ),
-
-                // SEÃ‡ENEK 2: Silme Ä°ÅŸlemi
                 ListTile(
                   leading: Container(
                     padding: const EdgeInsets.all(8),
@@ -745,7 +691,6 @@ class _ArchiveListTile extends ConsumerWidget {
     );
   }
 
-  // Silme Onay Dialogu ve Ä°ÅŸlemi
   Future<void> _confirmAndDelete(BuildContext context, WidgetRef ref) async {
     final confirm = await showDialog<bool>(
       context: context,
@@ -773,10 +718,14 @@ class _ArchiveListTile extends ConsumerWidget {
       try {
         await ref.read(firestoreServiceProvider).deleteTest(test.id);
 
+        // Provider'larÄ± invalidate et ki dashboard ve profile gÃ¼ncellensin
+        ref.invalidate(testsProvider);
+
+        onDeleted(); // Listeyi hemen yenile
         if (context.mounted) {
           ScaffoldMessenger.of(context).showSnackBar(
             SnackBar(
-              content: Text('${test.testName} baÅŸarÄ±yla silindi. Listeyi yenilemek iÃ§in sayfayÄ± aÅŸaÄŸÄ± Ã§ekin.'),
+              content: Text('${test.testName} baÅŸarÄ±yla silindi.'),
               behavior: SnackBarBehavior.floating,
             ),
           );
@@ -794,7 +743,6 @@ class _ArchiveListTile extends ConsumerWidget {
   @override
   Widget build(BuildContext context, WidgetRef ref) {
     final theme = Theme.of(context);
-    final colorScheme = theme.colorScheme;
     final textTheme = theme.textTheme;
     final acc = _accuracy(test);
     final isDark = theme.brightness == Brightness.dark;
@@ -819,7 +767,6 @@ class _ArchiveListTile extends ConsumerWidget {
         child: InkWell(
           borderRadius: BorderRadius.circular(16),
           onTap: () {
-            // Ana tÄ±klama artÄ±k direkt SavaÅŸ Raporuna (ArÅŸiv modunda) gidiyor
             if (isPremium || hasTemporaryAccess) {
               _goToWarReport(context);
             } else {
@@ -893,7 +840,9 @@ class _ArchiveListTile extends ConsumerWidget {
                               color: isDark ? Colors.white54 : Colors.black45,
                             ),
                           ),
-                          const SizedBox(width: 10),
+
+                          const Spacer(),
+
                           // DoÄŸruluk OranÄ± Rozeti
                           Container(
                             padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 3),
@@ -916,7 +865,7 @@ class _ArchiveListTile extends ConsumerWidget {
                   ),
                 ),
 
-                // 3. SEKTÃ–R STANDARDI THREE-DOTS MENU BUTONU
+                // 3. MENU BUTONU
                 IconButton(
                   icon: Icon(
                     Icons.more_vert_rounded,
@@ -932,4 +881,4 @@ class _ArchiveListTile extends ConsumerWidget {
       ),
     );
   }
-}
+}
\ No newline at end of file
diff --git a/lib/features/home/screens/test_result_summary_screen.dart b/lib/features/home/screens/test_result_summary_screen.dart
index 9c6f0aa..e77499d 100644
--- a/lib/features/home/screens/test_result_summary_screen.dart
+++ b/lib/features/home/screens/test_result_summary_screen.dart
@@ -60,7 +60,7 @@ class TestResultSummaryScreen extends ConsumerWidget {
           onPressed: () => fromArchive ? context.pop() : context.go('/home'),
         ),
         title: Text(
-          "SavaÅŸ Raporu",
+          "Deneme Raporu",
           style: theme.textTheme.titleMedium?.copyWith(
             fontWeight: FontWeight.w800,
             fontSize: 17,
diff --git a/lib/features/home/widgets/add_test_step1.dart b/lib/features/home/widgets/add_test_step1.dart
index e317c8d..997ac3f 100644
--- a/lib/features/home/widgets/add_test_step1.dart
+++ b/lib/features/home/widgets/add_test_step1.dart
@@ -15,142 +15,566 @@ class Step1TestInfo extends ConsumerWidget {
     final theme = Theme.of(context);
     final textTheme = theme.textTheme;
 
-    final isButtonEnabled =
-        state.testName.trim().isNotEmpty && state.selectedSection != null;
+    // Buton aktiflik kontrolÃ¼
+    final isButtonEnabled = state.testName.trim().isNotEmpty &&
+        state.selectedSection != null &&
+        (!state.isBranchMode || state.selectedBranchSubject != null);
 
-    return ListView(
-      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 32),
+    return Column(
       children: [
-        /// HEADER
-        Column(
-          children: [
-            Container(
-              width: 72,
-              height: 72,
-              decoration: BoxDecoration(
-                shape: BoxShape.circle,
-                color: theme.colorScheme.surfaceVariant,
+        Expanded(
+          child: ListView(
+            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 20),
+            children: [
+              /// HEADER
+              Column(
+                children: [
+                  Container(
+                    width: 56,
+                    height: 56,
+                    decoration: BoxDecoration(
+                      shape: BoxShape.circle,
+                      color: theme.colorScheme.primaryContainer,
+                    ),
+                    child: Icon(
+                      Icons.edit_note_rounded,
+                      size: 28,
+                      color: theme.colorScheme.onPrimaryContainer,
+                    ),
+                  ),
+                  const SizedBox(height: 12),
+                  Text(
+                    "Yeni Deneme Ekle",
+                    style: textTheme.headlineSmall?.copyWith(
+                      fontWeight: FontWeight.bold,
+                    ),
+                  ),
+                  const SizedBox(height: 6),
+                  Text(
+                    "Denemenin temel bilgilerini gir",
+                    textAlign: TextAlign.center,
+                    style: textTheme.bodyMedium?.copyWith(
+                      color: theme.colorScheme.onSurfaceVariant,
+                    ),
+                  ),
+                ],
+              ),
+
+              const SizedBox(height: 24),
+
+              /// MODE TOGGLE - Modern Segmented Control
+              Container(
+                decoration: BoxDecoration(
+                  color: theme.colorScheme.surfaceContainerHighest,
+                  borderRadius: BorderRadius.circular(12),
+                ),
+                padding: const EdgeInsets.all(4),
+                child: Row(
+                  children: [
+                    Expanded(
+                      child: _ModeToggleButton(
+                        label: "Genel Deneme",
+                        icon: Icons.library_books_rounded,
+                        isSelected: !state.isBranchMode,
+                        onTap: () {
+                          notifier.setBranchMode(false);
+                          if (state.selectedSection == null && state.availableSections.isNotEmpty) {
+                            notifier.setSection(state.availableSections.first);
+                          }
+                        },
+                      ),
+                    ),
+                    const SizedBox(width: 4),
+                    Expanded(
+                      child: _ModeToggleButton(
+                        label: "BranÅŸ Denemesi",
+                        icon: Icons.school_rounded,
+                        isSelected: state.isBranchMode,
+                        onTap: () {
+                          notifier.setBranchMode(true);
+                          if (state.selectedSection == null && state.availableSections.isNotEmpty) {
+                            notifier.setSection(state.availableSections.first);
+                          }
+                        },
+                      ),
+                    ),
+                  ],
+                ),
+              ),
+
+              const SizedBox(height: 24),
+
+              /// TEST NAME (Her iki modda da gerekli)
+              Text(
+                "Deneme AdÄ±",
+                style: textTheme.titleMedium?.copyWith(
+                  fontWeight: FontWeight.w600,
+                ),
               ),
-              child: Icon(
-                Icons.edit_note_rounded,
-                size: 36,
-                color: theme.colorScheme.primary,
+              const SizedBox(height: 10),
+              TextFormField(
+                initialValue: state.testName,
+                style: textTheme.bodyLarge,
+                decoration: InputDecoration(
+                  hintText: state.isBranchMode
+                      ? "Ã–rn: Tarih BranÅŸ Denemesi"
+                      : "Ã–rn: 3D YayÄ±nlarÄ± TÃ¼rkiye Geneli",
+                  hintStyle: TextStyle(
+                    fontSize: 15,
+                    color: theme.colorScheme.onSurfaceVariant.withValues(alpha: 0.6),
+                  ),
+                  prefixIcon: Icon(
+                    Icons.description_outlined,
+                    size: 22,
+                    color: theme.colorScheme.onSurfaceVariant,
+                  ),
+                  filled: true,
+                  fillColor: theme.colorScheme.surfaceContainerHighest,
+                  contentPadding: const EdgeInsets.symmetric(vertical: 16, horizontal: 16),
+                  border: OutlineInputBorder(
+                    borderRadius: BorderRadius.circular(14),
+                    borderSide: BorderSide.none,
+                  ),
+                  focusedBorder: OutlineInputBorder(
+                    borderRadius: BorderRadius.circular(14),
+                    borderSide: BorderSide(
+                      color: theme.colorScheme.primary,
+                      width: 2,
+                    ),
+                  ),
+                ),
+                onChanged: notifier.setTestName,
               ),
+
+              const SizedBox(height: 24),
+
+              /// MODE SELECTION AREA
+              AnimatedSize(
+                duration: const Duration(milliseconds: 300),
+                curve: Curves.easeInOutCubic,
+                child: AnimatedSwitcher(
+                  duration: const Duration(milliseconds: 250),
+                  switchInCurve: Curves.easeInOut,
+                  switchOutCurve: Curves.easeInOut,
+                  transitionBuilder: (child, animation) {
+                    return FadeTransition(
+                      opacity: animation,
+                      child: child,
+                    );
+                  },
+                  layoutBuilder: (currentChild, previousChildren) {
+                    return Stack(
+                      alignment: Alignment.topCenter,
+                      children: [
+                        ...previousChildren,
+                        if (currentChild != null) currentChild,
+                      ],
+                    );
+                  },
+                  child: state.isBranchMode
+                      ? _buildBranchMode(context, state, notifier)
+                      : _buildGeneralMode(context, state, notifier),
+                ),
+              ),
+            ]
+                .animate(interval: 50.ms)
+                .fadeIn(duration: 300.ms)
+                .slideY(begin: 0.1),
+          ),
+        ),
+
+        /// CTA - Sabit Buton
+        Container(
+          decoration: BoxDecoration(
+            gradient: LinearGradient(
+              begin: Alignment.topCenter,
+              end: Alignment.bottomCenter,
+              colors: [
+                theme.colorScheme.surface.withValues(alpha: 0.0),
+                theme.colorScheme.surface,
+              ],
+              stops: const [0.0, 0.3],
             ),
-            const SizedBox(height: 20),
-            Text(
-              "Yeni Deneme Ekle",
-              style: textTheme.headlineSmall?.copyWith(
-                fontWeight: FontWeight.bold,
+          ),
+          child: SafeArea(
+            top: false,
+            child: Padding(
+              padding: const EdgeInsets.fromLTRB(24, 20, 24, 12),
+              child: SizedBox(
+                height: 56,
+                width: double.infinity,
+                child: ElevatedButton(
+                  onPressed: isButtonEnabled ? notifier.nextStep : null,
+                  style: ElevatedButton.styleFrom(
+                    elevation: 0,
+                    backgroundColor: isButtonEnabled ? theme.colorScheme.primary : theme.colorScheme.surfaceContainerHighest,
+                    foregroundColor: theme.colorScheme.onPrimary,
+                    disabledBackgroundColor: theme.colorScheme.surfaceContainerHighest,
+                    disabledForegroundColor: theme.colorScheme.onSurfaceVariant,
+                    shadowColor: Colors.transparent,
+                    shape: RoundedRectangleBorder(
+                      borderRadius: BorderRadius.circular(16),
+                    ),
+                  ),
+                  child: Row(
+                    mainAxisAlignment: MainAxisAlignment.center,
+                    children: [
+                      const Icon(
+                        Icons.arrow_forward_rounded,
+                        size: 22,
+                      ),
+                      const SizedBox(width: 12),
+                      const Text(
+                        "Netleri Girmeye BaÅŸla",
+                        style: TextStyle(
+                          fontSize: 17,
+                          fontWeight: FontWeight.bold,
+                          letterSpacing: 0.3,
+                        ),
+                      ),
+                    ],
+                  ),
+                ),
               ),
             ),
-            const SizedBox(height: 8),
+          ),
+        ),
+      ],
+    );
+  }
+
+  // --- GENEL DENEME MODU GÃ–RÃœNÃœMÃœ ---
+  Widget _buildGeneralMode(BuildContext context, AddTestState state, AddTestNotifier notifier) {
+    final theme = Theme.of(context);
+    return Column(
+      key: const ValueKey('general_mode'),
+      crossAxisAlignment: CrossAxisAlignment.start,
+      children: [
+        Row(
+          children: [
+            Icon(
+              Icons.library_books_rounded,
+              size: 20,
+              color: theme.colorScheme.primary,
+            ),
+            const SizedBox(width: 10),
             Text(
-              "Denemenin temel bilgilerini girerek baÅŸlayalÄ±m.",
-              textAlign: TextAlign.center,
-              style: textTheme.bodyMedium?.copyWith(
-                color: theme.colorScheme.onSurfaceVariant,
+              "SÄ±nav TÃ¼rÃ¼ SeÃ§",
+              style: theme.textTheme.titleMedium?.copyWith(
+                fontWeight: FontWeight.w600,
               ),
             ),
           ],
         ),
+        const SizedBox(height: 16),
 
-        const SizedBox(height: 48),
-
-        /// TEST NAME
-        Text(
-          "Deneme AdÄ±",
-          style: textTheme.titleMedium?.copyWith(
-            fontWeight: FontWeight.w600,
+        // SÄ±nav tÃ¼rÃ¼ seÃ§imi
+        ...state.availableSections.map(
+              (section) => Padding(
+            padding: const EdgeInsets.only(bottom: 12),
+            child: _SectionSelectionCard(
+              section: section,
+              isSelected: state.selectedSection == section,
+              onTap: () => notifier.setSection(section),
+            ),
           ),
         ),
-        const SizedBox(height: 12),
-        TextFormField(
-          initialValue: state.testName,
-          decoration: InputDecoration(
-            hintText: "Ã–rn: 3D TÃ¼rkiye Geneli",
-            prefixIcon: Icon(
-              Icons.description_outlined,
-              color: theme.colorScheme.onSurfaceVariant,
+      ],
+    );
+  }
+
+  // --- BRANÅ DENEMESÄ° MODU GÃ–RÃœNÃœMÃœ ---
+  Widget _buildBranchMode(BuildContext context, AddTestState state, AddTestNotifier notifier) {
+    final theme = Theme.of(context);
+    return Column(
+      key: const ValueKey('branch_mode'),
+      crossAxisAlignment: CrossAxisAlignment.start,
+      children: [
+        // Ders SeÃ§imi
+        Row(
+          children: [
+            Icon(
+              Icons.menu_book_rounded,
+              size: 20,
+              color: theme.colorScheme.primary,
             ),
-            filled: true,
-            fillColor: theme.colorScheme.surfaceVariant,
-            border: OutlineInputBorder(
-              borderRadius: BorderRadius.circular(16),
-              borderSide: BorderSide.none,
+            const SizedBox(width: 10),
+            Text(
+              "Ders SeÃ§imi",
+              style: theme.textTheme.titleMedium?.copyWith(
+                fontWeight: FontWeight.w600,
+              ),
             ),
-            focusedBorder: OutlineInputBorder(
-              borderRadius: BorderRadius.circular(16),
-              borderSide: BorderSide(
-                color: theme.colorScheme.primary,
-                width: 2,
+          ],
+        ),
+        const SizedBox(height: 16),
+
+        // Ders seÃ§imi butonu
+        InkWell(
+          onTap: () => _showSubjectBottomSheet(context, state, notifier, theme),
+          borderRadius: BorderRadius.circular(14),
+          child: Container(
+            padding: const EdgeInsets.all(18),
+            decoration: BoxDecoration(
+              color: theme.colorScheme.surfaceContainerHighest,
+              borderRadius: BorderRadius.circular(14),
+              border: Border.all(
+                color: state.selectedBranchSubject != null
+                    ? theme.colorScheme.primary
+                    : theme.colorScheme.outlineVariant,
+                width: state.selectedBranchSubject != null ? 2 : 1,
               ),
             ),
+            child: Row(
+              children: [
+                Icon(
+                  state.selectedBranchSubject != null
+                      ? Icons.check_circle_rounded
+                      : Icons.add_circle_outline_rounded,
+                  color: state.selectedBranchSubject != null
+                      ? theme.colorScheme.primary
+                      : theme.colorScheme.onSurfaceVariant,
+                  size: 24,
+                ),
+                const SizedBox(width: 14),
+                Expanded(
+                  child: Text(
+                    state.selectedBranchSubject ?? "Ders SeÃ§",
+                    style: theme.textTheme.titleMedium?.copyWith(
+                      fontWeight: FontWeight.w600,
+                      color: state.selectedBranchSubject != null
+                          ? theme.colorScheme.onSurface
+                          : theme.colorScheme.onSurfaceVariant,
+                    ),
+                  ),
+                ),
+                Icon(
+                  Icons.arrow_forward_ios_rounded,
+                  size: 18,
+                  color: theme.colorScheme.onSurfaceVariant,
+                ),
+              ],
+            ),
           ),
-          onChanged: notifier.setTestName,
         ),
+      ],
+    );
+  }
 
-        const SizedBox(height: 40),
+  // Bottom sheet for subject selection - Sadece Ã§oklu dersi olan bÃ¶lÃ¼mleri gÃ¶ster
+  void _showSubjectBottomSheet(
+      BuildContext context,
+      AddTestState state,
+      AddTestNotifier notifier,
+      ThemeData theme,
+      ) {
+    // FÄ°LTRELEME Ä°ÅLEMÄ° BURADA YAPILIYOR
+    // Sadece birden fazla dersi olan bÃ¶lÃ¼mleri (section.subjects.length > 1) listeye alÄ±yoruz.
+    // Tek dersli sÄ±navlar (Ã–rn: TÃ¼rkÃ§e Ã–ABT) burada listelenmez.
+    final Map<String, List<String>> allSubjectsBySection = {};
+    for (final section in state.availableSections) {
+      if (section.subjects.length > 1) {
+        allSubjectsBySection[section.name] = section.subjects.keys.toList();
+      }
+    }
 
-        /// SECTION SELECTION
-        if (state.availableSections.length > 1) ...[
-          Text(
-            "Deneme TÃ¼rÃ¼",
-            style: textTheme.titleMedium?.copyWith(
-              fontWeight: FontWeight.w600,
-            ),
+    showModalBottomSheet(
+      context: context,
+      isScrollControlled: true,
+      backgroundColor: Colors.transparent,
+      builder: (context) => SafeArea(
+        child: Container(
+          constraints: BoxConstraints(
+            maxHeight: MediaQuery.of(context).size.height * 0.75,
           ),
-          const SizedBox(height: 16),
-          ...state.availableSections.map(
-                (section) => _SectionSelectionCard(
-              section: section,
-              isSelected: state.selectedSection == section,
-              onTap: () => notifier.setSection(section),
-            ),
+          decoration: BoxDecoration(
+            color: theme.colorScheme.surface,
+            borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
           ),
-        ],
-
-        const SizedBox(height: 48),
-
-        /// CTA
-        SafeArea(
-          top: false,
-          child: SizedBox(
-            height: 52,
-            width: double.infinity,
-            child: ElevatedButton(
-              onPressed: isButtonEnabled ? notifier.nextStep : null,
-              style: ElevatedButton.styleFrom(
-                elevation: isButtonEnabled ? 2 : 0,
-                backgroundColor: theme.colorScheme.primary,
-                foregroundColor: theme.colorScheme.onPrimary,
-                disabledBackgroundColor:
-                theme.colorScheme.surfaceVariant,
-                disabledForegroundColor:
-                theme.colorScheme.onSurfaceVariant,
-                shape: RoundedRectangleBorder(
-                  borderRadius: BorderRadius.circular(16),
+          child: Column(
+            mainAxisSize: MainAxisSize.min,
+            children: [
+              // Handle bar
+              Container(
+                margin: const EdgeInsets.only(top: 12),
+                width: 40,
+                height: 4,
+                decoration: BoxDecoration(
+                  color: theme.colorScheme.onSurfaceVariant.withValues(alpha: 0.4),
+                  borderRadius: BorderRadius.circular(2),
                 ),
               ),
-              child: const Text(
-                "Netleri Girmeye BaÅŸla",
-                style: TextStyle(
-                  fontSize: 16,
-                  fontWeight: FontWeight.w600,
+
+              // Header
+              Padding(
+                padding: const EdgeInsets.fromLTRB(24, 20, 24, 16),
+                child: Row(
+                  children: [
+                    Icon(
+                      Icons.menu_book_rounded,
+                      color: theme.colorScheme.primary,
+                      size: 24,
+                    ),
+                    const SizedBox(width: 12),
+                    Text(
+                      "Ders SeÃ§in",
+                      style: theme.textTheme.titleLarge?.copyWith(
+                        fontWeight: FontWeight.bold,
+                      ),
+                    ),
+                    const Spacer(),
+                    IconButton(
+                      onPressed: () => Navigator.pop(context),
+                      icon: const Icon(Icons.close_rounded),
+                      style: IconButton.styleFrom(
+                        backgroundColor: theme.colorScheme.surfaceContainerHighest,
+                      ),
+                    ),
+                  ],
                 ),
               ),
-            ),
+
+              const Divider(height: 1),
+
+              // Liste boÅŸsa (uygun ders yoksa) bilgilendirme gÃ¶ster
+              if (allSubjectsBySection.isEmpty)
+                Padding(
+                  padding: const EdgeInsets.all(32.0),
+                  child: Center(
+                    child: Column(
+                      children: [
+                        Icon(Icons.info_outline, size: 48, color: theme.colorScheme.secondary),
+                        const SizedBox(height: 16),
+                        Text(
+                          "BranÅŸ denemesi iÃ§in uygun, Ã§oklu ders iÃ§eren bir bÃ¶lÃ¼m bulunamadÄ±.",
+                          textAlign: TextAlign.center,
+                          style: theme.textTheme.bodyLarge,
+                        ),
+                        const SizedBox(height: 8),
+                        Text(
+                          "Tek derslik sÄ±navlarÄ± 'Genel Deneme' Ã¼zerinden ekleyebilirsiniz.",
+                          textAlign: TextAlign.center,
+                          style: theme.textTheme.bodyMedium?.copyWith(
+                              color: theme.colorScheme.onSurfaceVariant
+                          ),
+                        ),
+                      ],
+                    ),
+                  ),
+                )
+              else
+              // Subject list grouped by section
+                Flexible(
+                  child: ListView.builder(
+                    padding: const EdgeInsets.all(20),
+                    shrinkWrap: true,
+                    itemCount: allSubjectsBySection.length,
+                    itemBuilder: (context, index) {
+                      final sectionName = allSubjectsBySection.keys.elementAt(index);
+                      final subjects = allSubjectsBySection[sectionName]!;
+                      final section = state.availableSections.firstWhere((s) => s.name == sectionName);
+
+                      return Column(
+                        crossAxisAlignment: CrossAxisAlignment.start,
+                        children: [
+                          // BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ±
+                          if (allSubjectsBySection.length > 1) ...[
+                            Padding(
+                              padding: EdgeInsets.only(left: 4, bottom: 8, top: index > 0 ? 16 : 0),
+                              child: Row(
+                                children: [
+                                  Container(
+                                    padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
+                                    decoration: BoxDecoration(
+                                      color: theme.colorScheme.primaryContainer,
+                                      borderRadius: BorderRadius.circular(6),
+                                    ),
+                                    child: Text(
+                                      sectionName,
+                                      style: theme.textTheme.labelMedium?.copyWith(
+                                        color: theme.colorScheme.onPrimaryContainer,
+                                        fontWeight: FontWeight.bold,
+                                      ),
+                                    ),
+                                  ),
+                                ],
+                              ),
+                            ),
+                          ],
+
+                          // Dersler
+                          ...subjects.map((subject) {
+                            final isSelected = state.selectedBranchSubject == subject;
+                            return Padding(
+                              padding: const EdgeInsets.only(bottom: 8),
+                              child: InkWell(
+                                onTap: () {
+                                  // Dersi seÃ§ ve ilgili bÃ¶lÃ¼mÃ¼ de seÃ§
+                                  notifier.setSection(section);
+                                  notifier.setBranchSubject(subject);
+                                  Navigator.pop(context);
+                                },
+                                borderRadius: BorderRadius.circular(12),
+                                child: AnimatedContainer(
+                                  duration: const Duration(milliseconds: 200),
+                                  padding: const EdgeInsets.symmetric(
+                                    horizontal: 16,
+                                    vertical: 14,
+                                  ),
+                                  decoration: BoxDecoration(
+                                    color: isSelected
+                                        ? theme.colorScheme.primaryContainer
+                                        : theme.colorScheme.surfaceContainerHighest,
+                                    borderRadius: BorderRadius.circular(12),
+                                    border: Border.all(
+                                      color: isSelected
+                                          ? theme.colorScheme.primary
+                                          : Colors.transparent,
+                                      width: 2,
+                                    ),
+                                  ),
+                                  child: Row(
+                                    children: [
+                                      Icon(
+                                        isSelected
+                                            ? Icons.check_circle_rounded
+                                            : Icons.radio_button_unchecked,
+                                        color: isSelected
+                                            ? theme.colorScheme.primary
+                                            : theme.colorScheme.onSurfaceVariant,
+                                        size: 22,
+                                      ),
+                                      const SizedBox(width: 14),
+                                      Expanded(
+                                        child: Text(
+                                          subject,
+                                          style: theme.textTheme.titleSmall?.copyWith(
+                                            fontWeight: FontWeight.w600,
+                                            color: isSelected
+                                                ? theme.colorScheme.onPrimaryContainer
+                                                : theme.colorScheme.onSurface,
+                                          ),
+                                        ),
+                                      ),
+                                    ],
+                                  ),
+                                ),
+                              ),
+                            );
+                          }).toList(),
+                        ],
+                      );
+                    },
+                  ),
+                ),
+            ],
           ),
         ),
-      ]
-          .animate(interval: 70.ms)
-          .fadeIn(duration: 300.ms)
-          .slideY(begin: 0.12),
+      ),
     );
   }
 }
 
-/// SECTION CARD (RENK Ã‡AKIÅMASI YOK)
 class _SectionSelectionCard extends StatelessWidget {
   final ExamSection section;
   final bool isSelected;
@@ -165,43 +589,48 @@ class _SectionSelectionCard extends StatelessWidget {
   @override
   Widget build(BuildContext context) {
     final theme = Theme.of(context);
-
     return AnimatedContainer(
       duration: const Duration(milliseconds: 180),
-      margin: const EdgeInsets.only(bottom: 12),
       decoration: BoxDecoration(
-        borderRadius: BorderRadius.circular(16),
-        color: isSelected
-            ? theme.colorScheme.surfaceVariant
-            : theme.colorScheme.surface,
+        borderRadius: BorderRadius.circular(14),
+        color: theme.colorScheme.surface,
         border: Border.all(
           color: isSelected
               ? theme.colorScheme.primary
-              : theme.colorScheme.surfaceVariant,
-          width: 2,
+              : theme.colorScheme.outlineVariant,
+          width: isSelected ? 2 : 1,
         ),
       ),
       child: InkWell(
-        borderRadius: BorderRadius.circular(16),
+        borderRadius: BorderRadius.circular(14),
         onTap: onTap,
         child: Padding(
-          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
+          padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 16),
           child: Row(
             children: [
               Icon(
                 isSelected
                     ? Icons.check_circle_rounded
                     : Icons.radio_button_unchecked,
+                size: 24,
                 color: isSelected
                     ? theme.colorScheme.primary
                     : theme.colorScheme.onSurfaceVariant,
               ),
               const SizedBox(width: 16),
-              Text(
-                section.name,
-                style: theme.textTheme.titleMedium?.copyWith(
-                  fontWeight: FontWeight.w600,
-                  color: theme.colorScheme.onSurface,
+
+              Expanded(
+                child: FittedBox(
+                  fit: BoxFit.scaleDown,
+                  alignment: Alignment.centerLeft,
+                  child: Text(
+                    section.name,
+                    maxLines: 1,
+                    style: theme.textTheme.titleMedium?.copyWith(
+                      fontWeight: FontWeight.w600,
+                      color: theme.colorScheme.onSurface,
+                    ),
+                  ),
                 ),
               ),
             ],
@@ -211,3 +640,68 @@ class _SectionSelectionCard extends StatelessWidget {
     );
   }
 }
+
+// Modern Segmented Control Button Widget
+class _ModeToggleButton extends StatelessWidget {
+  final String label;
+  final IconData icon;
+  final bool isSelected;
+  final VoidCallback onTap;
+
+  const _ModeToggleButton({
+    required this.label,
+    required this.icon,
+    required this.isSelected,
+    required this.onTap,
+  });
+
+  @override
+  Widget build(BuildContext context) {
+    final theme = Theme.of(context);
+    return GestureDetector(
+      onTap: onTap,
+      child: AnimatedContainer(
+        duration: const Duration(milliseconds: 200),
+        curve: Curves.easeInOut,
+        padding: const EdgeInsets.symmetric(vertical: 14),
+        decoration: BoxDecoration(
+          color: isSelected
+              ? theme.colorScheme.primary
+              : Colors.transparent,
+          borderRadius: BorderRadius.circular(8),
+          boxShadow: isSelected
+              ? [
+            BoxShadow(
+              color: theme.colorScheme.primary.withValues(alpha: 0.3),
+              blurRadius: 8,
+              offset: const Offset(0, 2),
+            )
+          ]
+              : null,
+        ),
+        child: Row(
+          mainAxisAlignment: MainAxisAlignment.center,
+          children: [
+            Icon(
+              icon,
+              size: 20,
+              color: isSelected
+                  ? theme.colorScheme.onPrimary
+                  : theme.colorScheme.onSurfaceVariant,
+            ),
+            const SizedBox(width: 8),
+            Text(
+              label,
+              style: theme.textTheme.labelLarge?.copyWith(
+                color: isSelected
+                    ? theme.colorScheme.onPrimary
+                    : theme.colorScheme.onSurfaceVariant,
+                fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
+              ),
+            ),
+          ],
+        ),
+      ),
+    );
+  }
+}
\ No newline at end of file
diff --git a/lib/features/home/widgets/add_test_step2.dart b/lib/features/home/widgets/add_test_step2.dart
index d973cee..320f2a5 100644
--- a/lib/features/home/widgets/add_test_step2.dart
+++ b/lib/features/home/widgets/add_test_step2.dart
@@ -51,50 +51,72 @@ class _Step2ScoreEntryState extends ConsumerState<Step2ScoreEntry> {
   @override
   Widget build(BuildContext context) {
     final state = ref.watch(addTestProvider);
-    final section = state.selectedSection;
-    if (section == null) return const Center(child: Text("BÃ¶lÃ¼m seÃ§ilmedi."));
+
+    // DÄ°KKAT: selectedSection yerine activeSection kullanÄ±yoruz.
+    final section = state.activeSection;
+
+    if (section == null) return const Center(child: Text("BÃ¶lÃ¼m hatasÄ±."));
 
     final subjects = section.subjects.entries.toList();
 
-    return Column(
-      children: [
-        Expanded(
-          child: NotificationListener<ScrollNotification>(
-            onNotification: (notification) {
-              // PageView scroll olaylarÄ±nÄ± dinle
-              return false;
-            },
-            child: PageView.builder(
-              controller: _pageController,
-              physics: _isAnySliderActive
-                  ? const NeverScrollableScrollPhysics()
-                  : const PageScrollPhysics(),
-              itemCount: subjects.length,
-              itemBuilder: (context, index) {
-                final subjectEntry = subjects[index];
-                return _SubjectScoreCard(
-                  key: ValueKey(subjectEntry.key),
-                  subjectName: subjectEntry.key,
-                  details: subjectEntry.value,
-                  isFirst: index == 0,
-                  isLast: index == subjects.length - 1,
-                  currentPage: _currentPage,
-                  totalPages: subjects.length,
-                  onNext: () => _pageController.nextPage(duration: 200.ms, curve: Curves.easeOut),
-                  onPrevious: () => _pageController.previousPage(duration: 200.ms, curve: Curves.easeOut),
-                  pageController: _pageController,
-                  onSliderActiveChanged: _setSliderActive,
-                );
-              },
+    return SafeArea(
+      child: Column(
+        children: [
+          // BranÅŸ Modu Bilgisi
+          if (state.isBranchMode)
+            Container(
+              width: double.infinity,
+              padding: const EdgeInsets.symmetric(vertical: 8),
+              color: Theme.of(context).colorScheme.primaryContainer.withOpacity(0.3),
+              child: Text(
+                "BRANÅ DENEMESÄ°: ${subjects.first.key.toUpperCase()}",
+                textAlign: TextAlign.center,
+                style: TextStyle(
+                  fontWeight: FontWeight.bold,
+                  color: Theme.of(context).colorScheme.primary,
+                  letterSpacing: 1.1,
+                ),
+              ),
+            ),
+
+          Expanded(
+            child: NotificationListener<ScrollNotification>(
+              onNotification: (notification) => false,
+              child: PageView.builder(
+                controller: _pageController,
+                physics: _isAnySliderActive
+                    ? const NeverScrollableScrollPhysics()
+                    : const PageScrollPhysics(),
+                itemCount: subjects.length,
+                itemBuilder: (context, index) {
+                  final subjectEntry = subjects[index];
+                  return _SubjectScoreCard(
+                    key: ValueKey(subjectEntry.key),
+                    subjectName: subjectEntry.key,
+                    details: subjectEntry.value,
+                    isFirst: index == 0,
+                    isLast: index == subjects.length - 1,
+                    currentPage: _currentPage,
+                    totalPages: subjects.length,
+                    onNext: () => _pageController.nextPage(duration: 200.ms, curve: Curves.easeOut),
+                    onPrevious: () => _pageController.previousPage(duration: 200.ms, curve: Curves.easeOut),
+                    pageController: _pageController,
+                    onSliderActiveChanged: _setSliderActive,
+                  );
+                },
+              ),
             ),
           ),
-        ),
-      ],
+        ],
+      ),
     );
   }
 }
 
+// _SubjectScoreCard widget'Ä± Ã¶ncekiyle aynÄ± kalabilir,
+// sadece build iÃ§inde activeSection'a bakmasÄ± yeterli.
 class _SubjectScoreCard extends ConsumerStatefulWidget {
+  // ... parametreler aynÄ±
   final String subjectName;
   final SubjectDetails details;
   final bool isFirst, isLast;
@@ -123,7 +145,6 @@ class _SubjectScoreCard extends ConsumerStatefulWidget {
 
 class _SubjectScoreCardState extends ConsumerState<_SubjectScoreCard> {
   void _setSliding(bool value) {
-    // Parent widget'a bildir
     widget.onSliderActiveChanged(value);
   }
 
@@ -131,183 +152,113 @@ class _SubjectScoreCardState extends ConsumerState<_SubjectScoreCard> {
   Widget build(BuildContext context) {
     final notifier = ref.read(addTestProvider.notifier);
     final subjectScores = ref.watch(addTestProvider.select((s) => s.scores[widget.subjectName])) ?? {'dogru': 0, 'yanlis': 0};
-    final section = ref.watch(addTestProvider.select((s) => s.selectedSection))!;
+
+    // BURASI Ã–NEMLÄ°: activeSection'dan katsayÄ±yÄ± al
+    final section = ref.watch(addTestProvider.select((s) => s.activeSection))!;
 
     int correct = subjectScores['dogru']!;
     int wrong = subjectScores['yanlis']!;
     int blank = widget.details.questionCount - correct - wrong;
     double net = correct - (wrong * section.penaltyCoefficient);
 
+    // UI Kodunun geri kalanÄ± tamamen aynÄ±...
+    // (LayoutBuilder, Text'ler, ScoreSlider'lar, Butonlar)
     return LayoutBuilder(
-      builder: (context, constraints) {
-        // Ekran yÃ¼ksekliÄŸine gÃ¶re dinamik boÅŸluk hesaplama
-        final availableHeight = constraints.maxHeight;
-        final bool isCompact = availableHeight < 600;
-
-        return Padding(
-          padding: EdgeInsets.symmetric(
-            horizontal: 16.0,
-            vertical: isCompact ? 8.0 : 16.0,
-          ),
-          child: Column(
-            children: [
-              // BaÅŸlÄ±k bÃ¶lÃ¼mÃ¼
-              Text(
-                widget.subjectName,
-                style: Theme.of(context).textTheme.headlineSmall,
-                textAlign: TextAlign.center,
-                maxLines: 2,
-                overflow: TextOverflow.ellipsis,
-              ),
-              SizedBox(height: isCompact ? 2 : 4),
-              Text(
-                "${widget.details.questionCount} Soru",
-                style: Theme.of(context).textTheme.bodySmall?.copyWith(
-                  color: Theme.of(context).colorScheme.onSurfaceVariant,
-                ),
-              ),
+        builder: (context, constraints) {
+          // ... (AynÄ± kodlar)
+          // ScoreSlider onChanged iÃ§inde notifier.updateScores Ã§aÄŸÄ±rÄ±lÄ±yor
+          // Ä°statistik row'u net gÃ¶steriyor
+          // Son sayfada 'Ã–zeti GÃ¶rÃ¼ntÃ¼le' butonu var
 
-              const Spacer(),
+          // Kodu kÄ±saltmak iÃ§in burayÄ± tekrarlamÄ±yorum, Ã¶nceki dosyadan ScoreSlider ve UI yapÄ±sÄ±nÄ± aynen kullanabilirsiniz.
+          // Sadece 'section' deÄŸiÅŸkeninin activeSection olduÄŸundan emin olun.
 
-              // Slider'lar
-              GestureDetector(
-                onHorizontalDragStart: (_) {
-                  _setSliding(true);
-                },
-                onHorizontalDragEnd: (_) {
-                  _setSliding(false);
-                },
-                onHorizontalDragCancel: () {
-                  _setSliding(false);
-                },
-                child: AbsorbPointer(
-                  absorbing: false,
-                  child: ScoreSlider(
-                    label: "DoÄŸru",
-                    value: correct.toDouble(),
-                    max: widget.details.questionCount.toDouble(),
-                    color: Theme.of(context).colorScheme.secondary,
-                    totalQuestions: widget.details.questionCount.toDouble(),
-                    onChanged: (value) {
-                      final newCorrect = value.toInt();
-                      if (newCorrect + wrong > widget.details.questionCount) {
-                        final adjustedWrong = widget.details.questionCount - newCorrect;
-                        notifier.updateScores(widget.subjectName, correct: newCorrect, wrong: adjustedWrong);
-                      } else {
-                        notifier.updateScores(widget.subjectName, correct: newCorrect);
-                      }
-                    },
-                  ),
-                ),
-              ),
-              SizedBox(height: isCompact ? 8 : 12),
-              GestureDetector(
-                onHorizontalDragStart: (_) {
-                  _setSliding(true);
-                },
-                onHorizontalDragEnd: (_) {
-                  _setSliding(false);
-                },
-                onHorizontalDragCancel: () {
-                  _setSliding(false);
-                },
-                child: AbsorbPointer(
-                  absorbing: false,
-                  child: ScoreSlider(
-                    label: "YanlÄ±ÅŸ",
-                    value: wrong.toDouble(),
-                    max: (widget.details.questionCount - correct).toDouble(),
-                    color: Theme.of(context).colorScheme.error,
-                    totalQuestions: widget.details.questionCount.toDouble(),
-                    onChanged: (value) {
-                      final newWrong = value.toInt();
-                      if (newWrong + correct > widget.details.questionCount) {
-                        final adjustedCorrect = widget.details.questionCount - newWrong;
-                        notifier.updateScores(widget.subjectName, correct: adjustedCorrect, wrong: newWrong);
-                      } else {
-                        notifier.updateScores(widget.subjectName, wrong: newWrong);
-                      }
-                    },
-                  ),
-                ),
-              ),
-
-              const Spacer(),
-
-              // Ä°statistikler
-              Row(
-                mainAxisAlignment: MainAxisAlignment.spaceEvenly,
-                children: [
-                  _StatDisplay(label: "BoÅŸ", value: blank.toString()),
-                  Container(
-                    height: 40,
-                    width: 1,
-                    color: Theme.of(context).colorScheme.outlineVariant,
-                  ),
-                  _StatDisplay(label: "Net", value: net.toStringAsFixed(2)),
-                ],
-              ),
-
-              const Spacer(),
-
-              // Ã–zet butonu (sadece son sayfada) - sabit yÃ¼kseklik
-              SizedBox(
-                height: isCompact ? 50 : 56,
-                child: widget.isLast
-                    ? Center(
-                        child: ElevatedButton.icon(
-                          onPressed: () => notifier.nextStep(),
-                          icon: const Icon(Icons.summarize, size: 20),
-                          label: const Text('Ã–zeti GÃ¶rÃ¼ntÃ¼le'),
-                          style: ElevatedButton.styleFrom(
-                            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
-                          ),
-                        ),
-                      )
-                    : null,
-              ),
-
-              SizedBox(height: isCompact ? 4 : 8),
-
-              // Sayfa gÃ¶stergesi ve navigasyon - sabit alta
-              SizedBox(
-                height: 48,
-                child: Row(
-                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
+          // Kopyala-YapÄ±ÅŸtÄ±r yapabilmeniz iÃ§in minimal UI iskeleti:
+          return Padding(
+              padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 16.0),
+              child: Column(
                   children: [
-                    SizedBox(
-                      width: 48,
-                      height: 48,
-                      child: !widget.isFirst
-                          ? IconButton(
-                              icon: const Icon(Icons.arrow_back_ios),
-                              onPressed: widget.onPrevious,
-                            )
-                          : null,
+                    Text(widget.subjectName, style: Theme.of(context).textTheme.headlineSmall),
+                    Text("${widget.details.questionCount} Soru"),
+                    const Spacer(),
+                    // DoÄŸru Slider
+                    GestureDetector(
+                      onHorizontalDragStart: (_) => _setSliding(true),
+                      onHorizontalDragEnd: (_) => _setSliding(false),
+                      child: AbsorbPointer(
+                        absorbing: false,
+                        child: ScoreSlider(
+                            label: "DoÄŸru",
+                            value: correct.toDouble(),
+                            max: widget.details.questionCount.toDouble(),
+                            color: Theme.of(context).colorScheme.secondary,
+                            totalQuestions: widget.details.questionCount.toDouble(),
+                            onChanged: (v) {
+                              // MantÄ±k aynÄ±
+                              final val = v.toInt();
+                              if(val + wrong > widget.details.questionCount) {
+                                notifier.updateScores(widget.subjectName, correct: val, wrong: widget.details.questionCount - val);
+                              } else {
+                                notifier.updateScores(widget.subjectName, correct: val);
+                              }
+                            }
+                        ),
+                      ),
                     ),
-                    Text(
-                      '${widget.currentPage + 1} / ${widget.totalPages}',
-                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
-                        color: Theme.of(context).colorScheme.onSurfaceVariant,
+                    const SizedBox(height: 12),
+                    // YanlÄ±ÅŸ Slider
+                    GestureDetector(
+                      onHorizontalDragStart: (_) => _setSliding(true),
+                      onHorizontalDragEnd: (_) => _setSliding(false),
+                      child: AbsorbPointer(
+                        absorbing: false,
+                        child: ScoreSlider(
+                            label: "YanlÄ±ÅŸ",
+                            value: wrong.toDouble(),
+                            max: (widget.details.questionCount - correct).toDouble(),
+                            color: Theme.of(context).colorScheme.error,
+                            totalQuestions: widget.details.questionCount.toDouble(),
+                            onChanged: (v) {
+                              final val = v.toInt();
+                              if(val + correct > widget.details.questionCount) {
+                                notifier.updateScores(widget.subjectName, correct: widget.details.questionCount - val, wrong: val);
+                              } else {
+                                notifier.updateScores(widget.subjectName, wrong: val);
+                              }
+                            }
+                        ),
                       ),
                     ),
-                    SizedBox(
-                      width: 48,
-                      height: 48,
-                      child: !widget.isLast
-                          ? IconButton(
-                              icon: const Icon(Icons.arrow_forward_ios),
-                              onPressed: widget.onNext,
-                            )
-                          : null,
+                    const Spacer(),
+                    // Ä°statistikler (Net vb.)
+                    Row(
+                        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
+                        children: [
+                          _StatDisplay(label: "BoÅŸ", value: blank.toString()),
+                          _StatDisplay(label: "Net", value: net.toStringAsFixed(2)),
+                        ]
                     ),
-                  ],
-                ),
-              ),
-            ],
-          ),
-        );
-      },
+                    const Spacer(),
+                    // Navigasyon
+                    if(widget.isLast)
+                      ElevatedButton.icon(
+                          onPressed: notifier.nextStep,
+                          icon: const Icon(Icons.summarize),
+                          label: const Text("Ã–zeti GÃ¶rÃ¼ntÃ¼le")
+                      ),
+                    // Sayfa oklarÄ±...
+                    Row(
+                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
+                        children: [
+                          widget.isFirst ? const SizedBox(width: 48) : IconButton(icon: const Icon(Icons.arrow_back_ios), onPressed: widget.onPrevious),
+                          Text("${widget.currentPage+1}/${widget.totalPages}"),
+                          widget.isLast ? const SizedBox(width: 48) : IconButton(icon: const Icon(Icons.arrow_forward_ios), onPressed: widget.onNext),
+                        ]
+                    )
+                  ]
+              )
+          );
+        }
     );
   }
 }
@@ -320,21 +271,9 @@ class _StatDisplay extends StatelessWidget {
   @override
   Widget build(BuildContext context) {
     return Column(
-      mainAxisSize: MainAxisSize.min,
       children: [
-        Text(
-          value,
-          style: Theme.of(context).textTheme.headlineSmall?.copyWith(
-            fontWeight: FontWeight.bold,
-          ),
-        ),
-        const SizedBox(height: 4),
-        Text(
-          label,
-          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
-            color: Theme.of(context).colorScheme.onSurfaceVariant,
-          ),
-        ),
+        Text(value, style: Theme.of(context).textTheme.headlineSmall?.copyWith(fontWeight: FontWeight.bold)),
+        Text(label, style: Theme.of(context).textTheme.bodyMedium),
       ],
     );
   }
diff --git a/lib/features/home/widgets/add_test_step3.dart b/lib/features/home/widgets/add_test_step3.dart
index 1f4b0b3..0a7b332 100644
--- a/lib/features/home/widgets/add_test_step3.dart
+++ b/lib/features/home/widgets/add_test_step3.dart
@@ -12,7 +12,6 @@ import 'package:taktik/features/stats/logic/stats_analysis.dart';
 import 'package:lottie/lottie.dart';
 import 'package:taktik/core/navigation/app_routes.dart';
 import 'package:taktik/data/providers/premium_provider.dart';
-import 'package:taktik/core/services/admob_service.dart';
 import 'package:taktik/data/providers/monetization_provider.dart';
 import 'package:taktik/core/services/monetization_manager.dart';
 
@@ -67,12 +66,33 @@ class Step3Summary extends ConsumerWidget {
               if (user == null) return;
               notifier.setSaving(true);
 
+              // DÃœZELTME BAÅLANGICI: Ä°simlendirme MantÄ±ÄŸÄ±
+              // BranÅŸ denemesi seÃ§ilmiÅŸ olsa bile, eÄŸer ders "Alan Bilgisi" veya "Temel Alan Bilgisi" ise,
+              // bu aslÄ±nda o branÅŸÄ±n ana sÄ±navÄ±dÄ±r (Ã–rn: TÃ¼rkÃ§e Ã–ÄŸretmenliÄŸi).
+              // Bu yÃ¼zden bu Ã¶zel derslerde, ders adÄ± yerine Section (BÃ¶lÃ¼m) adÄ±nÄ± kullanarak kaydediyoruz.
+              // BÃ¶ylece "TÃ¼rkÃ§e Ã–ÄŸretmenliÄŸi" genel denemesi ile "Alan Bilgisi" denemesi aynÄ± isimde birleÅŸir.
+              String displaySectionName;
+              if (state.isBranchMode && state.selectedBranchSubject != null) {
+                if (state.selectedBranchSubject == 'Alan Bilgisi' ||
+                    state.selectedBranchSubject == 'Temel Alan Bilgisi') {
+                  // AGS/Ã–ABT iÃ§in Ã¶zel durum: BÃ¶lÃ¼m adÄ±nÄ± kullan
+                  displaySectionName = section.name;
+                } else {
+                  // DiÄŸer dersler (Matematik, Tarih vb.) iÃ§in ders adÄ±nÄ± kullan
+                  displaySectionName = state.selectedBranchSubject!;
+                }
+              } else {
+                // Genel mod: BÃ¶lÃ¼m adÄ±nÄ± kullan
+                displaySectionName = section.name;
+              }
+              // DÃœZELTME BÄ°TÄ°ÅÄ°
+
               final newTest = TestModel(
                 id: const Uuid().v4(),
                 userId: user.id,
                 testName: state.testName,
                 examType: ExamType.values.byName(user.selectedExam!),
-                sectionName: section.name,
+                sectionName: displaySectionName,
                 date: DateTime.now(),
                 scores: finalScores,
                 totalNet: totalNet,
@@ -116,21 +136,11 @@ class Step3Summary extends ConsumerWidget {
                   final monetizationManager = ref.read(monetizationManagerProvider);
                   final action = monetizationManager.getActionAfterTestSubmission();
 
-                  switch (action) {
-                    case MonetizationAction.showPaywall:
-                      // Paywall gÃ¶ster
-                      await context.push(AppRoutes.premium);
-                      break;
-                    case MonetizationAction.showAd:
-                      // Reklam gÃ¶ster
-                      await AdMobService().showInterstitialAd(
-                        dateOfBirth: user?.dateOfBirth,
-                      );
-                      break;
-                    case MonetizationAction.showNothing:
-                      // HiÃ§bir ÅŸey gÃ¶sterme (cooldown aktif)
-                      break;
+                  if (action == MonetizationAction.showPaywall) {
+                    // Paywall gÃ¶ster
+                    await context.push(AppRoutes.premium);
                   }
+                  // showNothing veya showAd durumunda hiÃ§bir ÅŸey yapma
                 }
 
                 if (context.mounted) {
@@ -159,13 +169,13 @@ class Step3Summary extends ConsumerWidget {
             },
             child: state.isSaving
                 ? SizedBox(
-                    height: 24,
-                    width: 24,
-                    child: CircularProgressIndicator(
-                      color: Theme.of(context).colorScheme.onPrimary,
-                      strokeWidth: 3,
-                    ),
-                  )
+              height: 24,
+              width: 24,
+              child: CircularProgressIndicator(
+                color: Theme.of(context).colorScheme.onPrimary,
+                strokeWidth: 3,
+              ),
+            )
                 : const Text('Kaydet ve Raporu GÃ¶rÃ¼ntÃ¼le'),
           ),
           TextButton(
@@ -260,4 +270,4 @@ class _SuccessDialogState extends State<_SuccessDialog> {
       ),
     );
   }
-}
+}
\ No newline at end of file
diff --git a/lib/features/stats/logic/stats_analysis.dart b/lib/features/stats/logic/stats_analysis.dart
index 7dd539e..25c1cbf 100644
--- a/lib/features/stats/logic/stats_analysis.dart
+++ b/lib/features/stats/logic/stats_analysis.dart
@@ -74,27 +74,52 @@ class StatsAnalysis {
 
     if(tests.isNotEmpty) {
       sortedTests = List.from(tests)..sort((a, b) => a.date.compareTo(b.date));
-      final allNets = sortedTests.map((t) => t.totalNet).toList();
+
+      // --- BRANÅ DENEMESÄ° AYRIÅTIRMA MANTIÄI ---
+
+      // 1. Genel Ä°statistikler (Warrior Score, Trend, Ortalama Net) iÃ§in kullanÄ±lacak liste.
+      // BranÅŸ denemelerini (Ã–rn: Sadece TÃ¼rkÃ§e) genel ortalamaya katmamak iÃ§in filtreliyoruz.
+      final mainTestsOnly = sortedTests.where((t) => !t.isBranchTest).toList();
+
+      // EÄŸer hiÃ§ ana deneme yoksa (kullanÄ±cÄ± sadece branÅŸ Ã§Ã¶zdÃ¼yse) mecburen hepsini kullan.
+      // Aksi takdirde sadece ana denemeleri (AGS, TYT vb.) kullan.
+      final statsSourceTests = mainTestsOnly.isNotEmpty ? mainTestsOnly : sortedTests;
+
+      // 2. HesaplamalarÄ± filtrelenmiÅŸ liste (statsSourceTests) Ã¼zerinden yap
+      final allNets = statsSourceTests.map((t) => t.totalNet).toList();
       averageNet = allNets.average;
-      final totalQuestionsAttempted = sortedTests.map((t) => t.totalCorrect + t.totalWrong).sum;
-      final totalCorrectAnswers = sortedTests.map((t) => t.totalCorrect).sum;
+
+      final totalQuestionsAttempted = statsSourceTests.map((t) => t.totalCorrect + t.totalWrong).sum;
+      final totalCorrectAnswers = statsSourceTests.map((t) => t.totalCorrect).sum;
+
       if (averageNet.abs() > 0.001) {
         final double stdDev = sqrt(allNets.map((n) => pow(n - averageNet, 2)).sum / allNets.length);
         consistency = max(0, (1 - (stdDev / averageNet.abs())) * 100);
       } else {
         consistency = 0.0;
       }
+
       accuracy = totalQuestionsAttempted > 0 ? (totalCorrectAnswers / totalQuestionsAttempted) * 100 : 0.0;
       trend = _calculateTrend(allNets);
-      netSpots = List.generate(sortedTests.length, (i) => FlSpot(i.toDouble(), sortedTests[i].totalNet));
-      final totalQuestionsInFirstTest = sortedTests.first.totalQuestions;
+
+      // Grafik noktalarÄ± da filtrelenmiÅŸ listeden oluÅŸturulmalÄ± (Ana ekrandaki grafik iÃ§in)
+      netSpots = List.generate(statsSourceTests.length, (i) => FlSpot(i.toDouble(), statsSourceTests[i].totalNet));
+
+      final totalQuestionsInFirstTest = statsSourceTests.first.totalQuestions;
+
+      // Warrior Score Hesaplama
       final netComponent = (totalQuestionsInFirstTest > 0)
           ? (averageNet / (totalQuestionsInFirstTest * 1.0)) * 50
           : 0.0;
       final accuracyComponent = (accuracy / 100) * 25;
       final consistencyComponent = (consistency / 100) * 15;
       final trendComponent = (atan(trend) / (pi / 2)) * 10;
+
       warriorScore = (netComponent + accuracyComponent + consistencyComponent + trendComponent).clamp(0, 100);
+
+      // 3. Ders BazlÄ± Analiz (Subject Breakdown)
+      // BURASI Ã‡OK Ã–NEMLÄ°: Ders istatistikleri iÃ§in TÃœM denemeleri (sortedTests) kullanÄ±yoruz.
+      // Ã‡Ã¼nkÃ¼ TÃ¼rkÃ§e branÅŸ denemesi Ã§Ã¶zen biri, genel netini dÃ¼ÅŸÃ¼rmese de TÃ¼rkÃ§e ortalamasÄ±nÄ± etkilemeli.
       final subjectNets = <String, List<double>>{};
       for (var test in sortedTests) {
         test.scores.forEach((subject, scores) {
@@ -274,6 +299,8 @@ class StatsAnalysis {
     if (sortedTests.length < 3) return;
 
     // Son 5 testin trendini hesapla
+    // Not: Trend analizi iÃ§in sortedTests kullanÄ±yoruz, bÃ¶ylece kullanÄ±cÄ± genel gidiÅŸatÄ±nÄ± (branÅŸlar dahil) gÃ¶rebilir.
+    // Ä°stenirse burasÄ± da statsSourceTests ile deÄŸiÅŸtirilebilir ama genelde "son Ã§Ã¶zÃ¼lenler" baÄŸlamÄ±nda hepsi istenir.
     final recentTests = sortedTests.length > 5 ? sortedTests.sublist(sortedTests.length - 5) : sortedTests;
     final recentNets = recentTests.map((t) => t.totalNet).toList();
     final recentTrend = _calculateTrend(recentNets);
diff --git a/lib/features/stats/screens/stats_screen.dart b/lib/features/stats/screens/stats_screen.dart
index 4e9de41..f853277 100644
--- a/lib/features/stats/screens/stats_screen.dart
+++ b/lib/features/stats/screens/stats_screen.dart
@@ -128,8 +128,8 @@ class _StatsScreenState extends ConsumerState<StatsScreen> {
                   repeat: true,
                 ),
               ).animate()
-                .fadeIn(duration: 500.ms)
-                .scale(begin: const Offset(0.8, 0.8), duration: 600.ms, curve: Curves.easeOutBack),
+                  .fadeIn(duration: 500.ms)
+                  .scale(begin: const Offset(0.8, 0.8), duration: 600.ms, curve: Curves.easeOutBack),
 
               const SizedBox(height: 24),
 
@@ -145,8 +145,8 @@ class _StatsScreenState extends ConsumerState<StatsScreen> {
                 ),
                 textAlign: TextAlign.center,
               ).animate(delay: 200.ms)
-                .fadeIn(duration: 400.ms)
-                .slideY(begin: 0.1, duration: 500.ms),
+                  .fadeIn(duration: 400.ms)
+                  .slideY(begin: 0.1, duration: 500.ms),
 
               const SizedBox(height: 12),
 
@@ -162,8 +162,8 @@ class _StatsScreenState extends ConsumerState<StatsScreen> {
                   fontSize: 15,
                 ),
               ).animate(delay: 300.ms)
-                .fadeIn(duration: 400.ms)
-                .slideY(begin: 0.1, duration: 500.ms),
+                  .fadeIn(duration: 400.ms)
+                  .slideY(begin: 0.1, duration: 500.ms),
 
               const SizedBox(height: 32),
 
@@ -236,9 +236,9 @@ class _StatsScreenState extends ConsumerState<StatsScreen> {
                   ),
                 ),
               ).animate(delay: 400.ms)
-                .fadeIn(duration: 500.ms)
-                .slideY(begin: 0.15, duration: 600.ms, curve: Curves.easeOutCubic)
-                .shimmer(delay: 800.ms, duration: 1500.ms),
+                  .fadeIn(duration: 500.ms)
+                  .slideY(begin: 0.15, duration: 600.ms, curve: Curves.easeOutCubic)
+                  .shimmer(delay: 800.ms, duration: 1500.ms),
             ],
           ),
         ),
@@ -270,7 +270,10 @@ class _StatsScreenState extends ConsumerState<StatsScreen> {
     final Widget body = userAsyncValue.when(
       data: (user) => testsAsyncValue.when(
         data: (tests) {
-          if (user == null || tests.isEmpty) {
+          // Sadece ana sÄ±nav denemeleri gÃ¶sterilsin (branÅŸ denemeleri hariÃ§)
+          final mainExamTests = tests.where((t) => !t.isBranchTest).toList();
+
+          if (user == null || mainExamTests.isEmpty) {
             return _buildEmptyState(context, isCompletelyEmpty: true);
           }
 
@@ -288,8 +291,15 @@ class _StatsScreenState extends ConsumerState<StatsScreen> {
               final exam = examSnapshot.data!;
 
               final groupedTests = <String, List<TestModel>>{};
-              for (final test in tests) {
-                (groupedTests[test.sectionName] ??= []).add(test);
+              for (final test in mainExamTests) {
+                // --- DÃœZELTME: Normalizasyon ---
+                // EÄŸer bÃ¶lÃ¼m adÄ± "YabancÄ± Dil" ise bunu "YDT" olarak kabul et
+                String sectionKey = test.sectionName;
+                if (sectionKey == 'YabancÄ± Dil') {
+                  sectionKey = 'YDT';
+                }
+
+                (groupedTests[sectionKey] ??= []).add(test);
               }
 
               final sortedGroups = groupedTests.entries.toList()
@@ -500,4 +510,4 @@ class _StatsScreenState extends ConsumerState<StatsScreen> {
       ),
     );
   }
-}
+}
\ No newline at end of file
diff --git a/lib/features/stats/widgets/cached_analysis_view.dart b/lib/features/stats/widgets/cached_analysis_view.dart
index 0b32f2a..f4c2ddb 100644
--- a/lib/features/stats/widgets/cached_analysis_view.dart
+++ b/lib/features/stats/widgets/cached_analysis_view.dart
@@ -80,13 +80,13 @@ class _CachedAnalysisViewState extends ConsumerState<CachedAnalysisView> with Si
             gradient: LinearGradient(
               colors: isDark
                   ? [
-                      Theme.of(context).colorScheme.surfaceContainerHighest.withValues(alpha: 0.5),
-                      Theme.of(context).colorScheme.surfaceContainerHighest.withValues(alpha: 0.25),
-                    ]
+                Theme.of(context).colorScheme.surfaceContainerHighest.withValues(alpha: 0.5),
+                Theme.of(context).colorScheme.surfaceContainerHighest.withValues(alpha: 0.25),
+              ]
                   : [
-                      Theme.of(context).cardColor.withValues(alpha: 0.95),
-                      Theme.of(context).colorScheme.surfaceContainerHighest.withValues(alpha: 0.3),
-                    ],
+                Theme.of(context).cardColor.withValues(alpha: 0.95),
+                Theme.of(context).colorScheme.surfaceContainerHighest.withValues(alpha: 0.3),
+              ],
               begin: Alignment.topLeft,
               end: Alignment.bottomRight,
             ),
@@ -99,7 +99,7 @@ class _CachedAnalysisViewState extends ConsumerState<CachedAnalysisView> with Si
             ),
             boxShadow: [
               BoxShadow(
-                color: isDark 
+                color: isDark
                     ? Theme.of(context).colorScheme.primary.withValues(alpha: 0.06)
                     : Colors.black.withValues(alpha: 0.08),
                 blurRadius: 10,
@@ -113,13 +113,13 @@ class _CachedAnalysisViewState extends ConsumerState<CachedAnalysisView> with Si
               gradient: LinearGradient(
                 colors: isDark
                     ? [
-                        Theme.of(context).colorScheme.primary.withValues(alpha: 0.9),
-                        Theme.of(context).colorScheme.primary.withValues(alpha: 0.75),
-                      ]
+                  Theme.of(context).colorScheme.primary.withValues(alpha: 0.9),
+                  Theme.of(context).colorScheme.primary.withValues(alpha: 0.75),
+                ]
                     : [
-                        Theme.of(context).colorScheme.secondary,
-                        Theme.of(context).colorScheme.secondary.withValues(alpha: 0.88),
-                      ],
+                  Theme.of(context).colorScheme.secondary,
+                  Theme.of(context).colorScheme.secondary.withValues(alpha: 0.88),
+                ],
               ),
               borderRadius: BorderRadius.circular(11),
               boxShadow: [
@@ -229,15 +229,15 @@ class _CachedAnalysisViewState extends ConsumerState<CachedAnalysisView> with Si
     // Sekme bazlÄ± Ã¶zellikler
     final features = title == 'Taktik Raporun'
         ? [
-            _FeatureItem(Icons.psychology_rounded, 'Yapay Zeka Analizi', 'PerformansÄ±nÄ± derinlemesine analiz et'),
-            _FeatureItem(Icons.lightbulb_rounded, 'KiÅŸisel Ã–neriler', 'Sana Ã¶zel strateji tavsiyeleri'),
-            _FeatureItem(Icons.trending_up_rounded, 'GeliÅŸim Yol HaritasÄ±', 'AdÄ±m adÄ±m ilerleme planÄ±'),
-          ]
+      _FeatureItem(Icons.psychology_rounded, 'Yapay Zeka Analizi', 'PerformansÄ±nÄ± derinlemesine analiz et'),
+      _FeatureItem(Icons.lightbulb_rounded, 'KiÅŸisel Ã–neriler', 'Sana Ã¶zel strateji tavsiyeleri'),
+      _FeatureItem(Icons.trending_up_rounded, 'GeliÅŸim Yol HaritasÄ±', 'AdÄ±m adÄ±m ilerleme planÄ±'),
+    ]
         : [
-            _FeatureItem(Icons.menu_book_rounded, 'Ders BazlÄ± Analiz', 'Her ders iÃ§in detaylÄ± istatistik'),
-            _FeatureItem(Icons.pie_chart_rounded, 'Konu DaÄŸÄ±lÄ±mÄ±', 'GÃ¼Ã§lÃ¼ ve zayÄ±f yÃ¶nlerini keÅŸfet'),
-            _FeatureItem(Icons.compare_arrows_rounded, 'KarÅŸÄ±laÅŸtÄ±rmalÄ± GÃ¶rÃ¼nÃ¼m', 'Dersler arasÄ± performans farkÄ±'),
-          ];
+      _FeatureItem(Icons.menu_book_rounded, 'Ders BazlÄ± Analiz', 'Her ders iÃ§in detaylÄ± istatistik'),
+      _FeatureItem(Icons.pie_chart_rounded, 'Konu DaÄŸÄ±lÄ±mÄ±', 'GÃ¼Ã§lÃ¼ ve zayÄ±f yÃ¶nlerini keÅŸfet'),
+      _FeatureItem(Icons.compare_arrows_rounded, 'KarÅŸÄ±laÅŸtÄ±rmalÄ± GÃ¶rÃ¼nÃ¼m', 'Dersler arasÄ± performans farkÄ±'),
+    ];
 
     return Container(
       decoration: BoxDecoration(
@@ -268,7 +268,7 @@ class _CachedAnalysisViewState extends ConsumerState<CachedAnalysisView> with Si
                       border: Border.all(color: Colors.amber.withOpacity(0.15), width: 2),
                     ),
                   ).animate(onPlay: (c) => c.repeat())
-                    .scale(begin: const Offset(0.95, 0.95), end: const Offset(1.08, 1.08), duration: 2000.ms, curve: Curves.easeInOut),
+                      .scale(begin: const Offset(0.95, 0.95), end: const Offset(1.08, 1.08), duration: 2000.ms, curve: Curves.easeInOut),
                   // Ana ikon
                   Container(
                     padding: const EdgeInsets.all(16),
@@ -345,10 +345,10 @@ class _CachedAnalysisViewState extends ConsumerState<CachedAnalysisView> with Si
                   ),
                 ),
               ).animate()
-                .fadeIn(delay: 350.ms)
-                .slideY(begin: 0.1, duration: 300.ms)
-                .then()
-                .shimmer(duration: 2000.ms, delay: 500.ms, color: Colors.white38),
+                  .fadeIn(delay: 350.ms)
+                  .slideY(begin: 0.1, duration: 300.ms)
+                  .then()
+                  .shimmer(duration: 2000.ms, delay: 500.ms, color: Colors.white38),
             ],
           ),
         ),
@@ -406,8 +406,8 @@ class _CachedAnalysisViewState extends ConsumerState<CachedAnalysisView> with Si
         ],
       ),
     ).animate()
-      .fadeIn(delay: Duration(milliseconds: 200 + (index * 60)))
-      .slideX(begin: 0.08, duration: 300.ms, curve: Curves.easeOutCubic);
+        .fadeIn(delay: Duration(milliseconds: 200 + (index * 60)))
+        .slideX(begin: 0.08, duration: 300.ms, curve: Curves.easeOutCubic);
   }
 
   // Tab 1: Ã–zet (Grafik + Metrikler)
@@ -505,4 +505,4 @@ class _FeatureItem {
   final String subtitle;
 
   _FeatureItem(this.icon, this.title, this.subtitle);
-}
+}
\ No newline at end of file
diff --git a/lib/features/stats/widgets/overview_content.dart b/lib/features/stats/widgets/overview_content.dart
index 10ae72e..acf0e8f 100644
--- a/lib/features/stats/widgets/overview_content.dart
+++ b/lib/features/stats/widgets/overview_content.dart
@@ -36,8 +36,11 @@ class OverviewContent extends ConsumerWidget {
       return _buildEmptyState(context, ref);
     }
 
-    final streak = StatsCalculator.calculateStreak(tests);
-    final avgNet = StatsCalculator.calculateAvgNet(user, tests);
+    // Hero kart ve genel metrikler branÅŸ denemelerinden etkilenmesin.
+    final mainExamTests = tests.where((t) => !t.isBranchTest).toList();
+
+    // MERKEZÄ° SÄ°STEM: Streak Firebase'den alÄ±nÄ±r, hesaplanmaz
+    final streak = StatsCalculator.getStreak(user);
 
     return CustomScrollView(
       physics: const BouncingScrollPhysics(),
@@ -48,10 +51,9 @@ class OverviewContent extends ConsumerWidget {
             padding: const EdgeInsets.fromLTRB(16, 6, 16, 10),
             child: PremiumHeroCard(
               user: user,
-              tests: tests,
+              tests: mainExamTests,
               isDark: isDark,
               streak: streak,
-              avgNet: avgNet,
             ).animate()
               .fadeIn(duration: 400.ms)
               .slideY(begin: -0.05, duration: 500.ms, curve: Curves.easeOutCubic)
@@ -59,8 +61,8 @@ class OverviewContent extends ConsumerWidget {
           ),
         ),
 
-        // Performans Grafikleri - Kompakt kaydÄ±rÄ±labilir kartlar
-        if (tests.isNotEmpty)
+        // Performans Grafikleri - Sadece ana sÄ±navlar (branÅŸ denemeleri hariÃ§)
+        if (tests.where((t) => !t.isBranchTest).isNotEmpty)
           SliverToBoxAdapter(
             child: Column(
               crossAxisAlignment: CrossAxisAlignment.start,
@@ -111,7 +113,7 @@ class OverviewContent extends ConsumerWidget {
                             ),
                             const SizedBox(height: 2),
                             Text(
-                              'GeliÅŸimini grafiklerle takip et',
+                              'Ana sÄ±navlardaki geliÅŸimini takip et',
                               style: TextStyle(
                                 fontSize: 11,
                                 fontWeight: FontWeight.w500,
@@ -169,7 +171,7 @@ class OverviewContent extends ConsumerWidget {
                 SizedBox(
                   height: 220,
                   child: SmartPerformanceCharts(
-                    tests: tests,
+                    tests: tests.where((t) => !t.isBranchTest).toList(),
                     isDark: isDark,
                     examType: user.selectedExam ?? 'YKS',
                   ).animate(delay: 350.ms).fadeIn(duration: 300.ms),
@@ -178,6 +180,85 @@ class OverviewContent extends ConsumerWidget {
             ),
           ),
 
+        // BranÅŸ Denemesi Trendleri - Sadece branÅŸ denemeleri
+        if (tests.where((t) => t.isBranchTest).isNotEmpty)
+          SliverToBoxAdapter(
+            child: Column(
+              crossAxisAlignment: CrossAxisAlignment.start,
+              children: [
+                Padding(
+                  padding: const EdgeInsets.fromLTRB(16, 8, 16, 10),
+                  child: Row(
+                    children: [
+                      Container(
+                        padding: const EdgeInsets.all(8),
+                        decoration: BoxDecoration(
+                          gradient: LinearGradient(
+                            begin: Alignment.topLeft,
+                            end: Alignment.bottomRight,
+                            colors: [
+                              AppTheme.primaryBrandColor,
+                              AppTheme.secondaryBrandColor,
+                            ],
+                          ),
+                          borderRadius: BorderRadius.circular(10),
+                          boxShadow: [
+                            BoxShadow(
+                              color: AppTheme.primaryBrandColor.withOpacity(0.35),
+                              blurRadius: 10,
+                              offset: const Offset(0, 4),
+                            ),
+                          ],
+                        ),
+                        child: const Icon(
+                          Icons.assignment_rounded,
+                          color: Colors.white,
+                          size: 16,
+                        ),
+                      ),
+                      const SizedBox(width: 12),
+                      Expanded(
+                        child: Column(
+                          crossAxisAlignment: CrossAxisAlignment.start,
+                          children: [
+                            Text(
+                              'BranÅŸ Denemesi Trendleri',
+                              style: TextStyle(
+                                fontSize: 15,
+                                fontWeight: FontWeight.w800,
+                                color: isDark ? Colors.white : const Color(0xFF0F172A),
+                                letterSpacing: -0.3,
+                              ),
+                            ),
+                            const SizedBox(height: 2),
+                            Text(
+                              'Ders bazlÄ± performansÄ±nÄ± takip et',
+                              style: TextStyle(
+                                fontSize: 11,
+                                fontWeight: FontWeight.w500,
+                                color: isDark
+                                    ? Colors.white.withOpacity(0.5)
+                                    : Colors.black.withOpacity(0.45),
+                              ),
+                            ),
+                          ],
+                        ),
+                      ),
+                    ],
+                  ).animate(delay: 320.ms).fadeIn().slideX(begin: -0.05),
+                ),
+                SizedBox(
+                  height: 220,
+                  child: SmartPerformanceCharts(
+                    tests: tests.where((t) => t.isBranchTest).toList(),
+                    isDark: isDark,
+                    examType: 'BRANCH',
+                  ).animate(delay: 370.ms).fadeIn(duration: 300.ms),
+                ),
+              ],
+            ),
+          ),
+
         // Konu PerformansÄ± Carousel - Yatay kaydÄ±rÄ±labilir (Coach screen'den girilen veriler)
         SliverToBoxAdapter(
           child: TopicPerformanceCarousel(
diff --git a/lib/features/stats/widgets/performance_charts.dart b/lib/features/stats/widgets/performance_charts.dart
index 419c41f..487d31f 100644
--- a/lib/features/stats/widgets/performance_charts.dart
+++ b/lib/features/stats/widgets/performance_charts.dart
@@ -3,6 +3,7 @@ import 'package:flutter/material.dart';
 import 'package:flutter_animate/flutter_animate.dart';
 import 'package:taktik/core/theme/app_theme.dart';
 import 'package:taktik/data/models/test_model.dart';
+import 'package:taktik/data/models/exam_model.dart';
 import 'package:taktik/features/stats/models/chart_data.dart';
 import 'package:taktik/features/stats/widgets/swipeable_performance_card.dart';
 
@@ -55,11 +56,53 @@ class _SmartPerformanceChartsState extends State<SmartPerformanceCharts> {
     final examType = widget.examType;
     final List<ChartData> chartDataList = [];
 
-    // YKS iÃ§in TYT ve AYT'yi ayÄ±r
-    if (examType == 'YKS') {
+    // BranÅŸ denemeleri iÃ§in
+    if (examType == 'BRANCH') {
+      final groupedTests = <String, List<TestModel>>{};
+      for (final test in tests) {
+        (groupedTests[test.smartDisplayName] ??= []).add(test);
+      }
+
+      final colors = [
+        const Color(0xFFF59E0B), // Amber
+        const Color(0xFFEF4444), // Red
+        const Color(0xFF8B5CF6), // Purple
+        const Color(0xFF06B6D4), // Cyan
+        const Color(0xFFEC4899), // Pink
+        const Color(0xFF10B981), // Emerald
+      ];
+      final icons = [
+        Icons.menu_book_rounded,
+        Icons.science_rounded,
+        Icons.calculate_rounded,
+        Icons.language_rounded,
+        Icons.public_rounded,
+        Icons.psychology_rounded,
+      ];
+
+      int index = 0;
+      for (final entry in groupedTests.entries) {
+        chartDataList.add(ChartData(
+          tests: entry.value,
+          title: entry.key,
+          subtitle: '${entry.value.length} deneme',
+          icon: icons[index % icons.length],
+          baseColor: colors[index % colors.length],
+        ));
+        index++;
+      }
+    }
+    // YKS iÃ§in TYT, AYT ve YDT ayrÄ±ÅŸtÄ±rmasÄ±
+    else if (examType == 'YKS') {
       final tytTests = tests.where((t) => t.sectionName.toUpperCase() == 'TYT').toList();
       final aytTests = tests.where((t) => t.sectionName.toUpperCase().startsWith('AYT')).toList();
 
+      // YDT (YabancÄ± Dil) Denemelerini Yakala
+      final ydtTests = tests.where((t) {
+        final name = t.sectionName.toUpperCase();
+        return name == 'YDT' || name == 'YABANCI DIL' || name == 'YABANCI DÄ°L';
+      }).toList();
+
       if (tytTests.isNotEmpty) {
         chartDataList.add(ChartData(
           tests: tytTests,
@@ -78,8 +121,18 @@ class _SmartPerformanceChartsState extends State<SmartPerformanceCharts> {
           baseColor: AppTheme.secondaryBrandColor,
         ));
       }
+      // YDT GrafiÄŸini Ekle
+      if (ydtTests.isNotEmpty) {
+        chartDataList.add(ChartData(
+          tests: ydtTests,
+          title: 'YDT',
+          subtitle: 'YabancÄ± Dil',
+          icon: Icons.language_rounded,
+          baseColor: const Color(0xFF06B6D4), // Cyan/Turkuaz
+        ));
+      }
 
-      // HiÃ§biri yoksa tÃ¼m testleri gÃ¶ster
+      // HiÃ§biri yoksa tÃ¼m testleri gÃ¶ster (Fallback)
       if (chartDataList.isEmpty) {
         chartDataList.add(ChartData(
           tests: tests,
@@ -90,45 +143,57 @@ class _SmartPerformanceChartsState extends State<SmartPerformanceCharts> {
         ));
       }
     } else {
-      // DiÄŸer sÄ±navlar iÃ§in bÃ¶lÃ¼mlere gÃ¶re grupla
+      // DÃœZELTME: DiÄŸer sÄ±navlar iÃ§in (AGS, KPSS vb.) mantÄ±k sadeleÅŸtirildi.
+      // ArtÄ±k tek grup olsa bile "Genel" isim yerine grubun kendi ismini (smartDisplayName) kullanÄ±yoruz.
       final groupedTests = <String, List<TestModel>>{};
       for (final test in tests) {
-        (groupedTests[test.sectionName] ??= []).add(test);
+        (groupedTests[test.smartDisplayName] ??= []).add(test);
       }
 
-      if (groupedTests.length > 1) {
-        final colors = [
-          AppTheme.primaryBrandColor,
-          AppTheme.secondaryBrandColor,
-          AppTheme.successBrandColor,
-          Colors.deepOrange,
-        ];
-        final icons = [
-          Icons.menu_book_rounded,
-          Icons.science_rounded,
-          Icons.calculate_rounded,
-          Icons.psychology_rounded,
-        ];
+      // Renk ve ikon paleti
+      final colors = [
+        AppTheme.primaryBrandColor,
+        AppTheme.secondaryBrandColor,
+        AppTheme.successBrandColor,
+        Colors.deepOrange,
+        const Color(0xFF8B5CF6), // Mor
+      ];
+      final icons = [
+        Icons.menu_book_rounded,
+        Icons.science_rounded,
+        Icons.calculate_rounded,
+        Icons.psychology_rounded,
+        Icons.lightbulb_rounded,
+      ];
+
+      // EÄŸer hiÃ§ test yoksa boÅŸ bir grafik gÃ¶ster
+      if (groupedTests.isEmpty) {
+        String displayTitle = examType;
+        try {
+          displayTitle = ExamType.values.byName(examType).displayName;
+        } catch (_) {}
 
+        chartDataList.add(ChartData(
+          tests: [],
+          title: displayTitle,
+          subtitle: 'Genel PerformansÄ±n',
+          icon: Icons.trending_up_rounded,
+          baseColor: AppTheme.successBrandColor,
+        ));
+      } else {
+        // Ä°ster 1 tane ister 10 tane grup olsun, hepsini kendi ismiyle listele.
+        // BÃ¶ylece "Alan Bilgisi" tek baÅŸÄ±na olsa bile adÄ± "AGS"ye dÃ¶nÃ¼ÅŸmez.
         int index = 0;
         for (final entry in groupedTests.entries) {
           chartDataList.add(ChartData(
             tests: entry.value,
-            title: entry.key,
+            title: entry.key, // Burada artÄ±k doÄŸrudan bÃ¶lÃ¼m/branÅŸ adÄ± yazacak
             subtitle: '${entry.value.length} deneme',
             icon: icons[index % icons.length],
             baseColor: colors[index % colors.length],
           ));
           index++;
         }
-      } else {
-        chartDataList.add(ChartData(
-          tests: tests,
-          title: examType.toUpperCase(),
-          subtitle: 'Genel PerformansÄ±n',
-          icon: Icons.trending_up_rounded,
-          baseColor: AppTheme.successBrandColor,
-        ));
       }
     }
 
@@ -150,8 +215,8 @@ class _SmartPerformanceChartsState extends State<SmartPerformanceCharts> {
                   data: data,
                   isDark: isDark,
                 ).animate(delay: (200 + index * 50).ms)
-                  .fadeIn(duration: 250.ms)
-                  .slideX(begin: 0.1),
+                    .fadeIn(duration: 250.ms)
+                    .slideX(begin: 0.1),
               );
             },
           ),
@@ -188,25 +253,25 @@ class _SmartPerformanceChartsState extends State<SmartPerformanceCharts> {
                       borderRadius: BorderRadius.circular(3),
                       gradient: isActive
                           ? LinearGradient(
-                              colors: [
-                                data.baseColor,
-                                data.baseColor.withOpacity(0.7),
-                              ],
-                            )
+                        colors: [
+                          data.baseColor,
+                          data.baseColor.withOpacity(0.7),
+                        ],
+                      )
                           : null,
                       color: isActive
                           ? null
                           : isDark
-                              ? Colors.white.withOpacity(0.2)
-                              : Colors.black.withOpacity(0.15),
+                          ? Colors.white.withOpacity(0.2)
+                          : Colors.black.withOpacity(0.15),
                       boxShadow: isActive
                           ? [
-                              BoxShadow(
-                                color: data.baseColor.withOpacity(0.4),
-                                blurRadius: 8,
-                                offset: const Offset(0, 2),
-                              ),
-                            ]
+                        BoxShadow(
+                          color: data.baseColor.withOpacity(0.4),
+                          blurRadius: 8,
+                          offset: const Offset(0, 2),
+                        ),
+                      ]
                           : null,
                     ),
                   );
@@ -228,5 +293,4 @@ class _SmartPerformanceChartsState extends State<SmartPerformanceCharts> {
       ],
     );
   }
-}
-
+}
\ No newline at end of file
